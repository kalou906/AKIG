#!/bin/bash

# üìã COMMANDES UTILES AKIG v3.0

echo "üöÄ AKIG v3.0 - COMMANDES UTILES"
echo "================================"
echo ""

# ============= D√âMARRAGE =============
echo "üü¢ D√âMARRAGE"
echo "docker-compose up -d                    # D√©marrer tout"
echo "docker-compose ps                       # V√©rifier services"
echo "docker-compose logs -f akig-backend     # Logs backend"
echo ""

# ============= V√âRIFICATIONS =============
echo "‚úÖ V√âRIFICATIONS"
echo "curl http://localhost:4000/api/health   # Health check backend"
echo "curl http://localhost:3000              # Health check frontend"
echo "docker ps | grep akig                   # Services AKIG"
echo ""

# ============= BASE DE DONN√âES =============
echo "üìä BASE DE DONN√âES"
echo "# Acc√©der √† PostgreSQL"
echo "docker exec -it akig-db psql -U akig_user -d akig"
echo ""
echo "# Commandes SQL utiles (une fois connect√©):"
echo "\\dt                                    # Lister les tables"
echo "SELECT COUNT(*) FROM impayes;           # Compter impay√©s"
echo "SELECT COUNT(*) FROM locataires;       # Compter locataires"
echo "SELECT * FROM missions LIMIT 5;        # Voir missions"
echo "\\q                                     # Quitter"
echo ""

# ============= REDIS =============
echo "üíæ REDIS CACHE"
echo "# Acc√©der √† Redis"
echo "docker exec -it akig-cache redis-cli"
echo ""
echo "# Commandes Redis (une fois connect√©):"
echo "PING                                    # Test connection"
echo "KEYS '*'                                # Voir toutes les cl√©s"
echo "GET perms:user-id-123                  # Voir une cl√©"
echo "FLUSHDB                                 # Vider le cache"
echo "INFO memory                             # Stats m√©moire"
echo "QUIT                                    # Quitter"
echo ""

# ============= LOGS =============
echo "üìù LOGS"
echo "docker logs -f akig-backend             # Backend temps r√©el"
echo "docker logs -f akig-frontend            # Frontend temps r√©el"
echo "docker logs -f akig-db                  # Database temps r√©el"
echo "docker logs -f akig-cache               # Redis temps r√©el"
echo "docker logs akig-backend | grep ERROR   # Erreurs backend"
echo ""

# ============= MONITORING =============
echo "üìà MONITORING"
echo "curl http://localhost:9090              # Prometheus (UI)"
echo "curl http://localhost:3001              # Grafana"
echo ""
echo "# Queries Prometheus utiles:"
echo "up                                      # Up status tous services"
echo "rate(http_requests_total[5m])           # Taux requ√™tes/sec"
echo "histogram_quantile(0.95, http_request_duration_seconds_bucket[5m])"
echo "                                        # Response time p95"
echo ""

# ============= PERFORMANCE =============
echo "‚ö° PERFORMANCE"
echo "# Tester un endpoint"
echo "curl -w '%{time_total}s\\n' http://localhost:4000/api/agents/classement/jour"
echo ""
echo "# Bench avec ab"
echo "ab -n 1000 -c 100 http://localhost:4000/api/dashboard/resume"
echo ""
echo "# Bench avec hey"
echo "hey -n 1000 -c 100 http://localhost:4000/api/dashboard/resume"
echo ""

# ============= D√âVELOPPEMENT =============
echo "üë®‚Äçüíª D√âVELOPPEMENT"
echo "# Linter + formater code"
echo "npm run lint --workspace=backend        # ESLint"
echo "npm run format --workspace=backend      # Prettier"
echo ""
echo "# Tests"
echo "npm test --workspace=backend            # Unit tests"
echo "npm run test:watch --workspace=backend  # Watch mode"
echo ""
echo "# Build Docker"
echo "docker build -f backend/Dockerfile -t akig:latest ./backend"
echo "docker build -f frontend/Dockerfile -t akig-frontend:latest ./frontend"
echo ""

# ============= NETTOYAGE =============
echo "üßπ NETTOYAGE"
echo "docker-compose down                     # Arr√™ter tout"
echo "docker-compose down -v                  # Arr√™ter + supprimer volumes"
echo "docker-compose restart                  # Red√©marrer"
echo "docker ps -a                            # Voir tous containers"
echo "docker images | grep akig               # Voir images"
echo ""

# ============= UTILITIES =============
echo "üîß UTILITIES"
echo "# V√©rifier les d√©pendances"
echo "npm ls --workspace=backend | head -50   # Backend deps"
echo "npm ls --workspace=frontend | head -50  # Frontend deps"
echo ""
echo "# Maj d√©pendances"
echo "npm update --workspace=backend"
echo "npm audit --workspace=backend           # Security audit"
echo ""

# ============= API TESTING =============
echo "üß™ API TESTING"
echo "# GET "
echo "curl http://localhost:4000/api/agents/classement/jour"
echo ""
echo "# POST avec donn√©es"
echo "curl -X POST http://localhost:4000/api/recouvrement/appel \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{\"locataire_id\": \"123\", \"agent_id\": \"456\"}'"
echo ""

# ============= DEBUGGING =============
echo "üêõ DEBUGGING"
echo "# V√©rifier r√©seau"
echo "docker network ls                       # R√©seaux"
echo "docker network inspect akig-network     # D√©tails r√©seau"
echo ""
echo "# Health check complet"
echo "echo '=== Backend ===' && curl http://localhost:4000/api/health"
echo "echo '=== Frontend ===' && curl -I http://localhost:3000"
echo "echo '=== Prometheus ===' && curl -I http://localhost:9090"
echo "echo '=== Grafana ===' && curl -I http://localhost:3001"
echo ""

# ============= PRODUCTION =============
echo "üöÄ PRODUCTION"
echo "# Blue-green deploy"
echo "docker tag akig:latest akig:v3.0"
echo "docker push akig:v3.0"
echo ""
echo "# Kubernetes (si ready)"
echo "kubectl apply -f ops/k8s/deployment.yaml"
echo "kubectl apply -f ops/k8s/service.yaml"
echo "kubectl apply -f ops/k8s/ingress.yaml"
echo ""

# ============= TROUBLESHOOTING =============
echo "üÜò TROUBLESHOOTING"
echo ""
echo "‚ùå Backend ne d√©marre pas?"
echo "   ‚Üí docker logs akig-backend | tail -50"
echo "   ‚Üí V√©rifier DATABASE_URL dans .env"
echo ""
echo "‚ùå BD indisponible?"
echo "   ‚Üí docker restart akig-db"
echo "   ‚Üí Voir runbook: /ops/runbooks/INCIDENTS.md"
echo ""
echo "‚ùå Cache slow?"
echo "   ‚Üí docker exec akig-cache redis-cli INFO memory"
echo "   ‚Üí Si >90% utilis√©: redis-cli FLUSHDB"
echo ""
echo "‚ùå Requ√™te lente?"
echo "   ‚Üí V√©rifier: curl -w '%{time_total}s' ..."
echo "   ‚Üí Voir dashboard: http://localhost:3001"
echo ""

# ============= RESSOURCES =============
echo "üìö RESSOURCES"
echo "Documentation:    /docs"
echo "Runbooks:         /ops/runbooks/INCIDENTS.md"
echo "Dev Setup:        /docs/onboarding/DEVELOPER_SETUP.md"
echo "ADRs:             /docs/adr/README.md"
echo ""

# ============= RACCOURCIS =============
echo "‚å®Ô∏è  RACCOURCIS (√Ä ajouter dans ~/.bashrc)"
echo ""
echo "# Ajouter ces lignes dans ~/.bashrc ou ~/.zshrc:"
echo ""
echo "# AKIG shortcuts"
echo "alias akig-start='cd ~/akig && docker-compose up -d'"
echo "alias akig-stop='cd ~/akig && docker-compose down'"
echo "alias akig-logs='cd ~/akig && docker-compose logs -f akig-backend'"
echo "alias akig-db='docker exec -it akig-db psql -U akig_user -d akig'"
echo "alias akig-redis='docker exec -it akig-cache redis-cli'"
echo "alias akig-health='curl http://localhost:4000/api/health | jq'"
echo ""

echo ""
echo "‚úÖ Besoin d'aide? Slack #dev-akig ou check /docs/"
