#!/bin/bash
# AKIG Security Deployment Quick Start
# Run this after reviewing the Master Index

echo "üîê AKIG Security Infrastructure Deployment Checklist"
echo "=================================================="
echo ""
echo "üìñ DOCUMENTATION REVIEW"
echo "[ ] Read SECURITY_MASTER_INDEX.md (2 min)"
echo "[ ] Read SECURITY_DELIVERY_SUMMARY.md (5 min)"
echo "[ ] Read ops/secrets-rotation/IMPLEMENTATION.md (10 min)"
echo ""
echo "üóÑÔ∏è  DATABASE SETUP (10 min)"
echo "[ ] Have PostgreSQL connection ready"
echo "    psql -U admin -d akig_prod"
echo ""
echo "[ ] Run RBAC migration:"
echo "    psql -f db/migrations/003_roles_permissions.sql"
echo ""
echo "[ ] Run Audit migration:"
echo "    psql -f db/migrations/004_access_audit.sql"
echo ""
echo "[ ] Verify tables created:"
echo "    psql -c \"SELECT tablename FROM pg_tables WHERE schemaname='public';\" | grep -E '(role|permission|audit)'"
echo ""
echo "üé´ BACKEND MIDDLEWARE SETUP (15 min)"
echo "[ ] Copy authorization middleware:"
echo "    cp backend/src/middleware/authorize.js backend/src/middleware/"
echo ""
echo "[ ] Copy RBAC middleware:"
echo "    cp backend/src/middleware/rbac.js backend/src/middleware/"
echo ""
echo "[ ] Copy audit middleware:"
echo "    cp backend/src/middleware/audit.js backend/src/middleware/"
echo ""
echo "[ ] Copy audit service:"
echo "    cp backend/src/services/auditService.js backend/src/services/"
echo ""
echo "[ ] Update backend/src/index.js to include:"
echo "    const { attachUserContext, requirePermission } = require('./middleware/authorize');"
echo "    const { auditMiddleware } = require('./middleware/audit');"
echo "    app.use(attachUserContext);"
echo "    app.use(auditMiddleware);"
echo ""
echo "[ ] Verify import: npm test -- --testPathPattern=middleware"
echo ""
echo "üî• WAF SETUP (30 min, Nginx server only)"
echo "[ ] Prerequisites:"
echo "    apt-get update && apt-get install -y build-essential apt-utils autoconf automake libtool"
echo ""
echo "[ ] Install ModSecurity:"
echo "    bash ops/nginx/install-modsecurity.sh"
echo ""
echo "[ ] Copy WAF configuration:"
echo "    sudo cp ops/nginx/waf.conf /etc/nginx/conf.d/"
echo "    sudo cp -r ops/nginx/modsec /etc/nginx/"
echo ""
echo "[ ] Test Nginx configuration:"
echo "    sudo nginx -t"
echo ""
echo "[ ] Reload Nginx:"
echo "    sudo systemctl reload nginx"
echo ""
echo "[ ] Test WAF blocking:"
echo "    curl -X GET \"http://localhost/?id=1' OR '1'='1\""
echo "    (Should return 403)"
echo ""
echo "[ ] Tail WAF logs:"
echo "    tail -f /var/log/modsecurity/audit.log"
echo ""
echo "üîë SECRETS ROTATION SETUP (5 min)"
echo "[ ] GitHub Secrets to configure (9 total):"
echo "    1. VAULT_ADDR=https://vault.akig.example.com"
echo "    2. VAULT_JWT_ROLE=github-actions-rotation"
echo "    3. VAULT_JWT_SECRET=(generate with Vault)"
echo "    4. VAULT_ENGINE_PATH=secret/akig"
echo "    5. K8S_CLUSTER_URL=https://k8s.akig.example.com"
echo "    6. K8S_SA_TOKEN=(service account token)"
echo "    7. K8S_NAMESPACE=production"
echo "    8. DB_HOST=postgres.akig.example.com"
echo "    9. DB_USER=akig_app"
echo ""
echo "[ ] Verify workflow file:"
echo "    cat .github/workflows/rotate-secrets.yml | head -20"
echo ""
echo "[ ] Enable GitHub Actions:"
echo "    Go to: Settings ‚Üí Actions ‚Üí General ‚Üí Allow all actions"
echo ""
echo "[ ] Test rotation (manual trigger):"
echo "    gh workflow run rotate-secrets.yml -f secret_type=jwt"
echo ""
echo "[ ] Check workflow status:"
echo "    gh run list --workflow=rotate-secrets.yml"
echo ""
echo "‚úÖ VERIFICATION (15 min)"
echo "[ ] Test authorization:"
echo "    curl -H 'Authorization: Bearer <token>' https://api.akig.example.com/api/admin"
echo ""
echo "[ ] Test audit logging:"
echo "    curl https://api.akig.example.com/api/invoices"
echo "    psql -c \"SELECT COUNT(*) FROM access_audit;\""
echo ""
echo "[ ] Test WAF rules:"
echo "    curl -X POST https://api.akig.example.com/api/login --data 'password=test<script>alert(1)</script>'"
echo ""
echo "[ ] Check all secrets rotated:"
echo "    psql -c \"SELECT COUNT(DISTINCT secret_name) FROM rotation_history;\""
echo ""
echo "üìä MONITORING SETUP"
echo "[ ] Create Slack webhook: https://api.slack.com/apps"
echo "[ ] Add webhook URL to GitHub secret: SLACK_WEBHOOK_URL"
echo "[ ] Configure PagerDuty integration (optional)"
echo ""
echo "üìö TEAM TRAINING"
echo "[ ] Send developers: docs/RBAC_SYSTEM.md"
echo "[ ] Send ops team: ops/secrets-rotation/README.md"
echo "[ ] Send security team: ops/nginx/README_WAF.md"
echo "[ ] Schedule team sync to discuss procedures"
echo ""
echo "üöÄ PRODUCTION DEPLOYMENT"
echo "[ ] Create deployment checklist"
echo "[ ] Schedule maintenance window (optional)"
echo "[ ] Deploy to staging first"
echo "[ ] Run smoke tests"
echo "[ ] Deploy to production"
echo "[ ] Monitor metrics"
echo "[ ] Verify all systems"
echo ""
echo "=================================================="
echo "‚úÖ Deployment Complete!"
echo ""
echo "üìñ Next Steps:"
echo "1. Review: SECURITY_MASTER_INDEX.md (complete reference)"
echo "2. Deploy: Follow the steps above"
echo "3. Train: Share documentation with team"
echo "4. Monitor: Watch logs and audit trails"
echo ""
echo "üÜò Issues? Check:"
echo "- Troubleshooting sections in relevant documentation"
echo "- Log files mentioned in documentation"
echo "- Example implementations in source files"
echo ""
echo "Contact: security@akig.example.com"
echo "=================================================="
