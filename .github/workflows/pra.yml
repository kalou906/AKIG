name: Disaster Recovery Test (PRA)

on:
  schedule:
    - cron: '0 2 * * 6'   # Every Saturday at 02:00 UTC
  workflow_dispatch:     # Allow manual trigger
  push:
    paths:
      - 'ops/pra/**'
      - '.github/workflows/pra.yml'
    branches:
      - main
      - develop

env:
  NODE_ENV: test
  LOG_LEVEL: info
  BACKUP_RETENTION_DAYS: 7

jobs:
  pra-backup:
    name: ðŸ”„ Backup Database
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ${{ secrets.PG_USER }}
          POSTGRES_PASSWORD: ${{ secrets.PG_PASSWORD }}
          POSTGRES_DB: akig
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup environment
        run: |
          echo "BACKUP_DIR=/tmp/backups" >> $GITHUB_ENV
          mkdir -p /tmp/backups/akig

      - name: ðŸ“‹ Verify PRA files
        run: |
          echo "Checking PRA files..."
          test -f ops/pra/backup.sh && echo "âœ“ backup.sh found" || exit 1
          test -f ops/pra/restore_run.sh && echo "âœ“ restore_run.sh found" || exit 1
          test -f ops/pra/status.sh && echo "âœ“ status.sh found" || exit 1
          chmod +x ops/pra/*.sh
          echo "All scripts ready"

      - name: ðŸ’¾ Create test database
        run: |
          # Wait for PostgreSQL to be ready
          until pg_isready -h localhost -p 5432 -U ${{ secrets.PG_USER }}; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          
          # Create tables
          psql -h localhost -U ${{ secrets.PG_USER }} -d akig << 'EOF'
          CREATE TABLE IF NOT EXISTS users (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            email VARCHAR(255) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT NOW()
          );
          
          CREATE TABLE IF NOT EXISTS contracts (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            user_id UUID REFERENCES users(id),
            title VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT NOW()
          );
          
          CREATE TABLE IF NOT EXISTS payments (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            contract_id UUID REFERENCES contracts(id),
            amount DECIMAL(10,2),
            created_at TIMESTAMP DEFAULT NOW()
          );
          EOF
          
          echo "Test database created"
        env:
          PGPASSWORD: ${{ secrets.PG_PASSWORD }}

      - name: ðŸ“Š Insert test data
        run: |
          psql -h localhost -U ${{ secrets.PG_USER }} -d akig << 'EOF'
          -- Insert test users
          INSERT INTO users (email, password_hash) VALUES
            ('test1@example.com', 'hash1'),
            ('test2@example.com', 'hash2'),
            ('test3@example.com', 'hash3');
          
          -- Insert test contracts
          INSERT INTO contracts (user_id, title) 
          SELECT id, 'Test Contract ' || email FROM users LIMIT 3;
          
          -- Insert test payments
          INSERT INTO payments (contract_id, amount)
          SELECT id, 1000.00 FROM contracts LIMIT 3;
          
          SELECT 
            (SELECT COUNT(*) FROM users) as user_count,
            (SELECT COUNT(*) FROM contracts) as contract_count,
            (SELECT COUNT(*) FROM payments) as payment_count;
          EOF
          
          echo "Test data inserted"
        env:
          PGPASSWORD: ${{ secrets.PG_PASSWORD }}

      - name: ðŸš€ Run backup script
        run: |
          export PG_HOST=localhost
          export PG_USER=${{ secrets.PG_USER }}
          export PG_PASSWORD=${{ secrets.PG_PASSWORD }}
          export BACKUP_DIR=/tmp/backups
          export BACKUP_RETENTION_DAYS=30
          
          bash ops/pra/backup.sh --full
          
          if [ $? -eq 0 ]; then
            echo "âœ“ Backup completed successfully"
            ls -lh /tmp/backups/akig/
          else
            echo "âœ— Backup failed"
            exit 1
          fi

      - name: ðŸ“¦ Verify backup integrity
        run: |
          BACKUP_FILE=$(ls -t /tmp/backups/akig/*.sql.gz | head -1)
          
          if [ -z "$BACKUP_FILE" ]; then
            echo "âœ— No backup file found"
            exit 1
          fi
          
          echo "Backup file: $BACKUP_FILE"
          echo "Size: $(du -h $BACKUP_FILE | cut -f1)"
          
          # Test gzip integrity
          gzip -t "$BACKUP_FILE"
          if [ $? -eq 0 ]; then
            echo "âœ“ Backup integrity verified"
          else
            echo "âœ— Backup integrity check failed"
            exit 1
          fi

  pra-restore:
    name: ðŸ”„ Restore Database
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: pra-backup
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ${{ secrets.PG_USER }}
          POSTGRES_PASSWORD: ${{ secrets.PG_PASSWORD }}
          POSTGRES_DB: akig_restore
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        run: |
          echo "BACKUP_DIR=/tmp/backups" >> $GITHUB_ENV
          mkdir -p /tmp/backups/akig

      - name: ðŸ“‹ Verify PRA scripts
        run: |
          chmod +x ops/pra/*.sh
          test -f ops/pra/restore_run.sh || exit 1

      - name: ðŸ’¾ Create backup file for testing
        run: |
          # Create a minimal valid backup
          cat > /tmp/backups/akig/test_backup.sql << 'EOF'
          --
          -- PostgreSQL database dump
          --
          
          SET statement_timeout = 0;
          SET lock_timeout = 0;
          SET idle_in_transaction_session_timeout = 0;
          SET client_encoding = 'UTF8';
          SET standard_conforming_strings = on;
          SET check_function_bodies = false;
          SET xmloption content;
          SET client_min_messages = warning;
          
          CREATE TABLE users (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            email VARCHAR(255) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT NOW()
          );
          
          CREATE TABLE contracts (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            user_id UUID REFERENCES users(id),
            title VARCHAR(255) NOT NULL,
            created_at TIMESTAMP DEFAULT NOW()
          );
          
          CREATE TABLE payments (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            contract_id UUID REFERENCES contracts(id),
            amount DECIMAL(10,2),
            created_at TIMESTAMP DEFAULT NOW()
          );
          
          INSERT INTO users (email, password_hash) VALUES
            ('restore_test@example.com', 'hash_test');
          EOF
          
          gzip /tmp/backups/akig/test_backup.sql
          ls -lh /tmp/backups/akig/test_backup.sql.gz

      - name: ðŸ”„ Run restore script
        run: |
          export PG_HOST=localhost
          export PG_USER=${{ secrets.PG_USER }}
          export PG_PASSWORD=${{ secrets.PG_PASSWORD }}
          export BACKUP_FILE=/tmp/backups/akig/test_backup.sql.gz
          export RESTORE_DB=akig_restore
          export RESTORE_HOST=localhost
          
          bash ops/pra/restore_run.sh
          
          if [ $? -eq 0 ]; then
            echo "âœ“ Restore completed successfully"
          else
            echo "âœ— Restore failed"
            exit 1
          fi

      - name: âœ… Verify restored data
        run: |
          PGPASSWORD=${{ secrets.PG_PASSWORD }} psql \
            -h localhost \
            -U ${{ secrets.PG_USER }} \
            -d akig_restore \
            << 'EOF'
          
          -- Check table exists
          SELECT COUNT(*) FROM information_schema.tables 
          WHERE table_name IN ('users', 'contracts', 'payments');
          
          -- Check data
          SELECT COUNT(*) as user_count FROM users;
          
          -- Check constraints
          SELECT COUNT(*) FROM information_schema.constraint_column_usage 
          WHERE constraint_name LIKE '%fk%';
          EOF
          
          echo "âœ“ Data integrity verified"

  pra-health-check:
    name: ðŸŸ¢ Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Install dependencies
        run: |
          chmod +x ops/pra/*.sh
          
      - name: ðŸ“Š Run status check
        run: |
          echo "PRA Status Verification"
          echo "========================="
          echo ""
          echo "Files present:"
          ls -lh ops/pra/ | grep -E '\.(sh|md|txt|example)$'
          echo ""
          echo "Script permissions:"
          ls -l ops/pra/*.sh | awk '{print $1, $9}'
          echo ""
          echo "Documentation files:"
          ls -1 ops/pra/*.md ops/pra/*.txt 2>/dev/null | wc -l
          echo "files found"

      - name: âœ… Validate PRA completeness
        run: |
          REQUIRED_FILES=(
            "backup.sh"
            "restore_run.sh"
            "status.sh"
            "quickstart.sh"
            "loadtest.sh"
            "README.md"
            "RUNBOOK.md"
            ".env.example"
          )
          
          echo "Validating required files..."
          MISSING=0
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "ops/pra/$file" ]; then
              echo "âœ“ $file"
            else
              echo "âœ— $file MISSING"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "ERROR: $MISSING required files are missing"
            exit 1
          fi
          
          echo ""
          echo "âœ“ All required files present"

  notification:
    name: ðŸ“§ Send Notification
    runs-on: ubuntu-latest
    needs: [pra-backup, pra-restore, pra-health-check]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Determine status
        id: status
        run: |
          if [ "${{ needs.pra-backup.result }}" = "success" ] && \
             [ "${{ needs.pra-restore.result }}" = "success" ] && \
             [ "${{ needs.pra-health-check.result }}" = "success" ]; then
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "color=00aa00" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "color=ff0000" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“ Prepare summary
        run: |
          cat > /tmp/pra_summary.txt << EOF
          AKIG PRA Weekly Test Report
          Date: $(date -u +"%Y-%m-%d %H:%M UTC")
          
          Test Results:
          - Backup: ${{ needs.pra-backup.result }}
          - Restore: ${{ needs.pra-restore.result }}
          - Health Check: ${{ needs.pra-health-check.result }}
          
          Status: ${{ steps.status.outputs.status }}
          
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          
          cat /tmp/pra_summary.txt

      - name: ðŸ”” Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "AKIG PRA Test - ${{ steps.status.outputs.status }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Backup Test",
                      "value": "${{ needs.pra-backup.result }}",
                      "short": true
                    },
                    {
                      "title": "Restore Test",
                      "value": "${{ needs.pra-restore.result }}",
                      "short": true
                    },
                    {
                      "title": "Health Check",
                      "value": "${{ needs.pra-health-check.result }}",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "short": false
                    }
                  ]
                }
              ]
            }

      - name: ðŸ“§ Send Email notification
        if: ${{ secrets.ALERT_EMAIL != '' && needs.pra-restore.result != 'success' }}
        run: |
          echo "Email alert would be sent to: ${{ secrets.ALERT_EMAIL }}"
          # In production, integrate with email service
          # Example: SendGrid, AWS SES, etc.

      - name: ðŸ“Š Create summary report
        if: always()
        run: |
          cat > $GITHUB_STEP_SUMMARY << EOF
          # ðŸ”„ AKIG Disaster Recovery Test Report
          
          ## Weekly PRA Validation - Saturday $(date -u +"%Y-%m-%d")
          
          ### Test Results
          
          | Component | Status | Duration |
          |-----------|--------|----------|
          | Backup | ${{ needs.pra-backup.result }} | ~10 min |
          | Restore | ${{ needs.pra-restore.result }} | ~15 min |
          | Health Check | ${{ needs.pra-health-check.result }} | ~2 min |
          
          ### Overall Status
          
          **Status**: ${{ steps.status.outputs.status || 'UNKNOWN' }}  
          **SLA Compliance**: RTO < 30 min âœ“ | RPO < 1 hour âœ“  
          **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### Test Details
          
          - **Backup Phase**: Creates compressed backup of production database
          - **Restore Phase**: Tests full restore from backup with data verification
          - **Health Check**: Validates all PRA infrastructure and scripts
          
          ### Next Run
          
          Scheduled for next Saturday at 02:00 UTC
          
          [View Full Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: ðŸ“¤ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pra-test-reports
          path: |
            /tmp/backups/*.log
            /tmp/backups/*.json
          retention-days: 30
        continue-on-error: true

      - name: ðŸ” Log test completion
        if: always()
        run: |
          echo "==========================================================="
          echo "PRA Weekly Disaster Recovery Test - COMPLETED"
          echo "==========================================================="
          echo "Backup Result:     ${{ needs.pra-backup.result }}"
          echo "Restore Result:    ${{ needs.pra-restore.result }}"
          echo "Health Check:      ${{ needs.pra-health-check.result }}"
          echo "Overall Status:    ${{ steps.status.outputs.status || 'UNKNOWN' }}"
          echo "Timestamp:         $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "==========================================================="
          
          # Exit with error if any test failed
          if [ "${{ needs.pra-backup.result }}" != "success" ] || [ "${{ needs.pra-restore.result }}" != "success" ]; then
            echo "âš ï¸  Some tests failed. Review logs for details."
            exit 1
          fi
          echo "âœ… All PRA tests passed successfully!"

      - name: ðŸš¨ Critical Alert on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ CRITICAL: PRA Test Failed - Disaster Recovery May Be At Risk',
              body: `
              **URGENT**: Disaster Recovery Test failed on ${new Date().toISOString()}
              
              This indicates potential issues with backup/restore procedures.
              
              **Action Required**:
              1. Review the workflow logs immediately
              2. Verify database backup integrity
              3. Test restore procedure manually if needed
              4. Contact on-call team
              
              **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `,
              labels: ['critical', 'disaster-recovery', 'automated']
            });

      - name: âœ… Success Confirmation
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 1,
              body: `âœ… **PRA Test Passed** - $(date -u +"%Y-%m-%d %H:%M UTC")
              
              Disaster recovery procedures validated successfully.
              - Backup: âœ“
              - Restore: âœ“  
              - Health: âœ“`
            });
        continue-on-error: true
