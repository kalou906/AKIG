name: Dependencies Security

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/package*.json'
      - 'frontend/package*.json'
      - '.github/workflows/deps-security.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/package*.json'
      - 'frontend/package*.json'
  schedule:
    - cron: '0 4 * * 1'   # Every Monday at 04:00 UTC
  workflow_dispatch:

concurrency:
  group: deps-security-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 18
  CACHE_NAME_PREFIX: 'deps-security'

jobs:
  npm-audit-backend:
    name: ğŸ” NPM Audit Backend
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'
      
      - name: ğŸ“‹ Install dependencies
        working-directory: backend
        run: npm ci
      
      - name: ğŸ” Run npm audit
        working-directory: backend
        id: audit-backend
        continue-on-error: true
        run: |
          echo "### NPM Audit Backend" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate --json > audit-report.json || EXIT_CODE=$?
          cat audit-report.json >> $GITHUB_STEP_SUMMARY
          exit ${EXIT_CODE:-0}
      
      - name: ğŸ“¤ Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-backend
          path: backend/audit-report.json
          retention-days: 30
      
      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('backend/audit-report.json', 'utf8'));
            
            let vulnerabilities = '';
            if (report.vulnerabilities) {
              Object.entries(report.vulnerabilities).forEach(([pkg, info]) => {
                vulnerabilities += `\n- **${pkg}**: ${info.severity} - ${info.title}`;
              });
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âš ï¸ **NPM Audit Backend Alert**\n\n${vulnerabilities || 'No vulnerabilities found'}`
            });

  npm-audit-frontend:
    name: ğŸ” NPM Audit Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: ğŸ“‹ Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ” Run npm audit
        working-directory: frontend
        id: audit-frontend
        continue-on-error: true
        run: |
          echo "### NPM Audit Frontend" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate --json > audit-report.json || EXIT_CODE=$?
          cat audit-report.json >> $GITHUB_STEP_SUMMARY
          exit ${EXIT_CODE:-0}
      
      - name: ğŸ“¤ Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-frontend
          path: frontend/audit-report.json
          retention-days: 30
      
      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('frontend/audit-report.json', 'utf8'));
            
            let vulnerabilities = '';
            if (report.vulnerabilities) {
              Object.entries(report.vulnerabilities).forEach(([pkg, info]) => {
                vulnerabilities += `\n- **${pkg}**: ${info.severity} - ${info.title}`;
              });
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âš ï¸ **NPM Audit Frontend Alert**\n\n${vulnerabilities || 'No vulnerabilities found'}`
            });

  snyk-backend:
    name: ğŸ›¡ï¸ Snyk Backend Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'
      
      - name: ğŸ“‹ Install dependencies
        working-directory: backend
        run: npm ci
      
      - name: ğŸ›¡ï¸ Run Snyk scan
        uses: snyk/actions/node@master
        if: secrets.SNYK_TOKEN != ''
        with:
          command: test
          args: backend --severity-threshold=high --json-file-output=snyk-report.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: ğŸ›¡ï¸ Monitor with Snyk
        uses: snyk/actions/node@master
        if: github.event_name == 'push' && secrets.SNYK_TOKEN != ''
        with:
          command: monitor
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-backend-report
          path: snyk-report.json
          retention-days: 30

  snyk-frontend:
    name: ğŸ›¡ï¸ Snyk Frontend Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: ğŸ“‹ Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ›¡ï¸ Run Snyk scan
        uses: snyk/actions/node@master
        if: secrets.SNYK_TOKEN != ''
        with:
          command: test
          args: frontend --severity-threshold=high --json-file-output=snyk-report.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: ğŸ›¡ï¸ Monitor with Snyk
        uses: snyk/actions/node@master
        if: github.event_name == 'push' && secrets.SNYK_TOKEN != ''
        with:
          command: monitor
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Snyk report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-frontend-report
          path: snyk-report.json
          retention-days: 30

  dependency-check:
    name: ğŸ“Š Dependency Check (OWASP)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”„ Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        if: secrets.OWASP_ENABLED == 'true'
        with:
          project: 'AKIG'
          path: '.'
          format: 'JSON'
          args: >
            --enableExperimental
            --enableRetired
            --suppression .github/dependency-check-suppressions.xml
        continue-on-error: true
      
      - name: ğŸ“¤ Upload OWASP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 30

  license-check:
    name: ğŸ“œ License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: ğŸ” Check backend licenses
        working-directory: backend
        continue-on-error: true
        run: |
          npm install -g license-check-and-gather
          lc-and-gather --csv license-report.csv
          echo "### Backend Licenses" >> $GITHUB_STEP_SUMMARY
          cat license-report.csv >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ” Check frontend licenses
        working-directory: frontend
        continue-on-error: true
        run: |
          npm install -g license-check-and-gather
          lc-and-gather --csv license-report.csv
          echo "### Frontend Licenses" >> $GITHUB_STEP_SUMMARY
          cat license-report.csv >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload license reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            backend/license-report.csv
            frontend/license-report.csv
          retention-days: 30

  security-summary:
    name: ğŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit-backend, npm-audit-frontend, snyk-backend, snyk-frontend, dependency-check, license-check]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“Š Generate summary
        run: |
          echo "# ğŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit Backend | ${{ needs.npm-audit-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit Frontend | ${{ needs.npm-audit-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Backend | ${{ needs.snyk-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Frontend | ${{ needs.snyk-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP Dependency-Check | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql-scan.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload combined artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-all
          path: |
            backend/audit-report.json
            frontend/audit-report.json
            snyk-backend-report.json
            snyk-frontend-report.json
          retention-days: 90
      
      - name: ğŸš¨ Notify if failures
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Security Scan Failures Detected',
              body: `Security scans failed on ${context.ref}. Check workflow run for details.`,
              labels: ['security', 'automated']
            });

  codeql-scan:
    name: ğŸ” CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
      
      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v2
      
      - name: ğŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{ matrix.language }}"

  report-upload:
    name: ğŸ“ˆ Upload to Security Dashboard
    runs-on: ubuntu-latest
    needs: [security-summary, codeql-scan]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports/
        continue-on-error: true
      
      - name: ğŸ“¤ Upload to dashboard
        env:
          DASHBOARD_URL: ${{ secrets.SECURITY_DASHBOARD_URL }}
          DASHBOARD_TOKEN: ${{ secrets.SECURITY_DASHBOARD_TOKEN }}
        run: |
          if [ -n "$DASHBOARD_URL" ] && [ -n "$DASHBOARD_TOKEN" ]; then
            curl -X POST "$DASHBOARD_URL/api/scans" \
              -H "Authorization: Bearer $DASHBOARD_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "repository": "${{ github.repository }}",
                "branch": "${{ github.ref_name }}",
                "commit": "${{ github.sha }}",
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
                "status": "success"
              }' \
              || echo "Dashboard upload skipped"
          else
            echo "Dashboard not configured"
          fi
        continue-on-error: true
              }' || echo "Dashboard upload skipped"
          fi
        continue-on-error: true
