name: Vault Secret Management

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy secrets'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - sync-secrets
          - rotate-credentials
          - verify-secrets

env:
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  VAULT_NAMESPACE: solvency

jobs:
  setup-vault:
    name: Setup Vault Secrets
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Vault CLI
        uses: hashicorp/setup-vault@v2
        with:
          version: '1.15.4'
      
      - name: Login to Vault via GitHub Auth
        run: |
          vault login -no-store -method=github token=${{ secrets.VAULT_GITHUB_TOKEN }}
      
      - name: Sync Secrets to Vault
        if: inputs.action == 'sync-secrets'
        run: |
          echo "Syncing secrets to Vault for ${{ inputs.environment }}"
          
          # API Secrets
          vault kv put secret/solvency/api \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            JWT_EXPIRES_IN="24h" \
            SENDGRID_API_KEY="${{ secrets.SENDGRID_API_KEY }}" \
            VAPID_PUBLIC_KEY="${{ secrets.VAPID_PUBLIC_KEY }}" \
            VAPID_PRIVATE_KEY="${{ secrets.VAPID_PRIVATE_KEY }}" \
            SENTRY_DSN="${{ secrets.SENTRY_DSN }}"
          
          # Database Secrets
          vault kv put secret/solvency/database \
            POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
          
          # AWS Credentials
          vault kv put secret/solvency/aws \
            AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            AWS_REGION="${{ secrets.AWS_REGION }}"
          
          # SMTP Credentials
          vault kv put secret/solvency/smtp \
            SMTP_HOST="${{ secrets.SMTP_HOST }}" \
            SMTP_PORT="${{ secrets.SMTP_PORT }}" \
            SMTP_USER="${{ secrets.SMTP_USER }}" \
            SMTP_PASS="${{ secrets.SMTP_PASS }}"
          
          echo "✅ Secrets synced successfully"
      
      - name: Rotate Database Credentials
        if: inputs.action == 'rotate-credentials'
        run: |
          echo "Rotating database credentials"
          
          # Generate new dynamic credentials
          NEW_CREDS=$(vault read -format=json database/creds/solvency-app)
          
          echo "New credentials generated:"
          echo $NEW_CREDS | jq -r '.data | "Username: \(.username)"'
          
          # Update application configuration
          # (This would typically trigger a deployment with new creds)
          
          echo "✅ Credentials rotated"
      
      - name: Verify Secrets
        if: inputs.action == 'verify-secrets'
        run: |
          echo "Verifying secrets in Vault"
          
          # Check each secret path
          vault kv get secret/solvency/api
          vault kv get secret/solvency/database
          vault kv get secret/solvency/aws
          vault kv get secret/solvency/smtp
          
          echo "✅ All secrets verified"
      
      - name: Audit Log
        if: always()
        run: |
          echo "Recording audit log"
          vault write audit/file-audit \
            path="github-actions-${{ inputs.environment }}-$(date +%Y%m%d-%H%M%S).log" \
            description="GitHub Actions secret sync"

  configure-vault-policies:
    name: Configure Vault Policies
    runs-on: ubuntu-latest
    if: inputs.action == 'sync-secrets'
    needs: setup-vault
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Vault CLI
        uses: hashicorp/setup-vault@v2
      
      - name: Login to Vault
        run: |
          vault login -no-store -method=github token=${{ secrets.VAULT_GITHUB_TOKEN }}
      
      - name: Create/Update Policies
        run: |
          # Solvency API Policy
          vault policy write solvency-api - <<EOF
          # Read secrets
          path "secret/data/solvency/*" {
            capabilities = ["read"]
          }
          
          # Generate dynamic DB credentials
          path "database/creds/solvency-app" {
            capabilities = ["read"]
          }
          
          # Generate TLS certificates
          path "pki/issue/solvency-api" {
            capabilities = ["create", "update"]
          }
          
          # Transit encryption
          path "transit/encrypt/solvency-key" {
            capabilities = ["update"]
          }
          
          path "transit/decrypt/solvency-key" {
            capabilities = ["update"]
          }
          EOF
          
          echo "✅ Policies configured"
      
      - name: Configure Kubernetes Auth
        run: |
          # Enable Kubernetes auth if not already
          vault auth enable -path=kubernetes kubernetes || true
          
          # Configure Kubernetes auth
          vault write auth/kubernetes/config \
            kubernetes_host="https://kubernetes.default.svc:443" \
            kubernetes_ca_cert=@$KUBE_CA_CERT \
            token_reviewer_jwt=@$KUBE_JWT
          
          # Create role for solvency-api
          vault write auth/kubernetes/role/solvency-api \
            bound_service_account_names=solvency-api-sa \
            bound_service_account_namespaces=solvency-ai \
            policies=solvency-api \
            ttl=24h
          
          echo "✅ Kubernetes auth configured"

  setup-dynamic-database:
    name: Configure Dynamic Database Credentials
    runs-on: ubuntu-latest
    if: inputs.action == 'sync-secrets'
    needs: setup-vault
    
    steps:
      - name: Setup Vault CLI
        uses: hashicorp/setup-vault@v2
      
      - name: Login to Vault
        run: |
          vault login -no-store -method=github token=${{ secrets.VAULT_GITHUB_TOKEN }}
      
      - name: Enable Database Secrets Engine
        run: |
          # Enable database secrets engine
          vault secrets enable -path=database database || true
          
          # Configure PostgreSQL connection
          vault write database/config/solvency-postgres \
            plugin_name=postgresql-database-plugin \
            allowed_roles="solvency-app,solvency-readonly" \
            connection_url="postgresql://{{username}}:{{password}}@${{ secrets.DB_HOST }}:5432/solvency_dev" \
            username="${{ secrets.DB_ADMIN_USER }}" \
            password="${{ secrets.DB_ADMIN_PASSWORD }}"
          
          # Create role for application
          vault write database/roles/solvency-app \
            db_name=solvency-postgres \
            creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; \
              GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO \"{{name}}\";" \
            default_ttl="1h" \
            max_ttl="24h"
          
          echo "✅ Dynamic database credentials configured"
