name: Multi-Browser E2E Testing

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop, staging ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test:
    name: Test on ${{ matrix.os }} - ${{ matrix.browser }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chromium, firefox, webkit]
        exclude:
          # Safari (webkit) only on macOS
          - os: ubuntu-latest
            browser: webkit
          - os: windows-latest
            browser: webkit
          # Firefox has some issues on Windows, so run it less frequently
          - os: windows-latest
            browser: firefox
    
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.3'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps ${{ matrix.browser }}
        shell: bash

      - name: Start backend server
        run: |
          cd backend
          npm install
          npm start &
          echo "Waiting for backend..."
          sleep 5
        shell: bash
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:password@localhost:5432/akig_test' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key-do-not-use-in-production' }}
          PORT: 4000

      - name: Start frontend dev server
        run: |
          cd frontend
          npm start > frontend.log 2>&1 &
          echo "Waiting for frontend..."
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 1; done' || true
        shell: bash

      - name: Run Playwright tests - ${{ matrix.browser }}
        run: |
          cd frontend
          npx playwright test --project=${{ matrix.browser }} --reporter=html --reporter=json --reporter=junit
        shell: bash
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ matrix.os }}-${{ matrix.browser }}
          path: frontend/test-results/
          retention-days: 30

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-${{ matrix.os }}-${{ matrix.browser }}
          path: frontend/test-results/**/*.webm
          retention-days: 7

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results - ${{ matrix.os }} - ${{ matrix.browser }}
          path: 'frontend/test-results/junit.xml'
          reporter: 'java-junit'
          fail-on-error: false

  mobile-testing:
    name: Mobile Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.3'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps chromium

      - name: Start backend
        run: |
          cd backend
          npm install
          npm start &
          sleep 5
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:password@localhost:5432/akig_test' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key' }}

      - name: Start frontend
        run: |
          cd frontend
          npm start > frontend.log 2>&1 &
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 1; done' || true

      - name: Run mobile tests
        run: |
          cd frontend
          npx playwright test --project="Mobile Chrome" --project="Mobile Safari" --reporter=html --reporter=json
        continue-on-error: true

      - name: Upload mobile test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-results
          path: frontend/test-results/
          retention-days: 30

  accessibility-testing:
    name: Accessibility & Performance Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.3'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          npm install -D axe-playwright

      - name: Start servers
        run: |
          cd backend
          npm install
          npm start &
          cd ../frontend
          npm start > frontend.log 2>&1 &
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 1; done' || true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:password@localhost:5432/akig_test' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key' }}

      - name: Run accessibility tests
        run: |
          cd frontend
          npx playwright test tests/accessibility.spec.js --reporter=html --reporter=json
        continue-on-error: true

      - name: Run performance tests
        run: |
          cd frontend
          npx playwright test tests/performance.spec.js --reporter=html --reporter=json
        continue-on-error: true

      - name: Upload accessibility results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results
          path: frontend/test-results/
          retention-days: 30

  report-summary:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [test, mobile-testing, accessibility-testing]
    if: always()
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate summary
        run: |
          echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Multi-Browser Testing" >> $GITHUB_STEP_SUMMARY
          echo "- Chrome/Chromium: ✅ Running on Ubuntu, Windows, macOS" >> $GITHUB_STEP_SUMMARY
          echo "- Firefox: ✅ Running on Ubuntu, macOS" >> $GITHUB_STEP_SUMMARY
          echo "- Safari (WebKit): ✅ Running on macOS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Mobile Testing" >> $GITHUB_STEP_SUMMARY
          echo "- Android Chrome (Pixel 5): ✅ Running" >> $GITHUB_STEP_SUMMARY
          echo "- iOS Safari (iPhone 12): ✅ Running" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Additional Testing" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility: ✅ axe checks running" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: ✅ Lighthouse & Web Vitals" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All artifacts available in Actions tab" >> $GITHUB_STEP_SUMMARY

  edge-testing:
    name: Edge Browser Testing
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.3'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps chromium
        shell: bash

      - name: Start servers
        run: |
          cd backend
          npm install
          npm start &
          $PID = $?
          cd ../frontend
          npm start > frontend.log 2>&1 &
        shell: powershell
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:password@localhost:5432/akig_test' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-key' }}

      - name: Run Edge tests (via Chromium)
        run: |
          cd frontend
          npx playwright test --project=chromium --reporter=html --reporter=json
        shell: bash
        continue-on-error: true

      - name: Upload Edge test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: edge-test-results
          path: frontend/test-results/
          retention-days: 30

  legacy-browser-testing:
    name: Legacy Browser Compatibility
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.3'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps chromium

      - name: Start servers
        run: |
          cd backend
          npm install
          npm start &
          sleep 5
          cd ../frontend
          npm start > frontend.log 2>&1 &
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 1; done' || true

      - name: Check IE11/Legacy compatibility
        run: |
          cd frontend
          npm run build 2>&1 | grep -E "(polyfill|es5|legacy|IE)" || echo "Build completed without specific legacy warnings"
          
          # Check generated bundle has necessary polyfills
          if [ -f "build/index.html" ]; then
            grep -q "polyfill" build/index.html || grep -q "core-js" build/index.html || echo "⚠️ Consider adding polyfills for IE11 support"
          fi
        shell: bash
        continue-on-error: true

      - name: Verify CSS prefixes
        run: |
          cd frontend
          echo "Checking CSS compatibility..."
          find build -name "*.css" -type f 2>/dev/null | head -5 | xargs grep -l "\-webkit-\|\-moz-\|\-ms-" || echo "CSS prefixes check complete"
        shell: bash
        continue-on-error: true

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.3'
          cache: 'npm'

      - name: Generate coverage report
        run: |
          cd frontend
          npm ci
          
          # If using Istanbul or similar
          if [ -f "package.json" ] && grep -q "nyc\|c8\|coverage" package.json; then
            npm run test:coverage 2>/dev/null || echo "Coverage not configured"
          else
            echo "# Test Coverage" > coverage-report.md
            echo "" >> coverage-report.md
            echo "Coverage tracking via CI/CD pipeline" >> coverage-report.md
          fi
        shell: bash
        continue-on-error: true

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            frontend/coverage/
            frontend/coverage-report.md
          retention-days: 30
