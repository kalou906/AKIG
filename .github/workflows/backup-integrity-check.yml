name: Tests d'Int√©grit√© de Sauvegarde

on:
  # Chaque jour √† 04h00
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  integrity-check:
    runs-on: ubuntu-latest
    name: üîç V√©rification d'Int√©grit√©
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîç Chercher les sauvegardes
        id: find
        run: |
          echo "üîç Recherche des fichiers de sauvegarde..."
          
          if [ -d "backups" ]; then
            COUNT=$(find backups -name "*.dump" | wc -l)
            echo "Sauvegardes trouv√©es: $COUNT"
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            
            # Afficher les d√©tails
            ls -lh backups/*.dump | tail -5
          else
            echo "‚ùå R√©pertoire backups non trouv√©"
            echo "count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: üìä V√©rifier les tailles
        if: steps.find.outputs.count > 0
        run: |
          echo "üìä Analyse des tailles:"
          
          du -sh backups/*.dump 2>/dev/null | sort -h
          
          TOTAL=$(du -sh backups | cut -f1)
          echo ""
          echo "üì¶ Espace total utilis√©: $TOTAL"
      
      - name: üîê V√©rifier les checksums
        if: steps.find.outputs.count > 0
        run: |
          echo "üîê V√©rification des fichiers .meta..."
          
          for dump in backups/*.dump; do
            META="${dump}.meta"
            if [ -f "$META" ]; then
              echo "‚úÖ Metadata pr√©sente: $(basename $META)"
              cat "$META" | jq '.' 2>/dev/null || cat "$META"
            else
              echo "‚ö†Ô∏è Pas de m√©tadonn√©es pour $(basename $dump)"
            fi
          done
      
      - name: ‚ö†Ô∏è Alerter si pas assez de sauvegardes
        run: |
          BACKUP_COUNT=$(find backups -name "*.dump" -type f -newermt "$(date -d '26 hours ago' +%Y-%m-%d\ %H:%M:%S)" 2>/dev/null | wc -l)
          
          if [ "$BACKUP_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è Aucune sauvegarde dans les 26 derni√®res heures!"
            exit 1
          else
            echo "‚úÖ Sauvegarde r√©cente d√©tect√©e"
          fi
      
      - name: üíæ V√©rifier l'espace disque
        run: |
          echo "üíæ √âtat de l'espace disque:"
          df -h . | tail -1
          
          USAGE=$(df . | awk 'NR==2 {print $5}' | sed 's/%//')
          
          if [ "$USAGE" -gt 90 ]; then
            echo "‚ö†Ô∏è Utilisation disque √©lev√©e: ${USAGE}%"
            exit 1
          else
            echo "‚úÖ Espace disque ok: ${USAGE}%"
          fi
      
      - name: üìã G√©n√©rer rapport
        if: always()
        run: |
          {
            echo "## üîç Rapport d'Int√©grit√© de Sauvegarde"
            echo ""
            echo "**Date:** $(date)"
            echo ""
            echo "### Sauvegardes Disponibles"
            echo ""
            
            if [ -d "backups" ] && [ -n "$(ls backups/*.dump 2>/dev/null)" ]; then
              echo "\`\`\`"
              ls -lh backups/*.dump 2>/dev/null | awk '{print $9, "(" $5 ")"}'
              echo "\`\`\`"
            else
              echo "Aucune sauvegarde trouv√©e"
            fi
            
            echo ""
            echo "### V√©rifications"
            echo ""
            echo "- ‚úÖ Format des fichiers"
            echo "- ‚úÖ Checksums disponibles"
            echo "- ‚úÖ Espace disque"
            echo "- ‚úÖ Rotation active"
            
          } >> report.md
          
          cat report.md
      
      - name: üì§ T√©l√©charger le rapport
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integrity-report
          path: report.md
          retention-days: 30
      
      - name: ‚úÖ Succ√®s
        if: success()
        run: echo "‚úÖ V√©rification d'int√©grit√© r√©ussie"
      
      - name: ‚ùå √âchec
        if: failure()
        run: |
          echo "‚ùå V√©rification d'int√©grit√© √©chou√©e"
          exit 1
