name: Deploy Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      migrations:
        description: 'Specific migration (leave empty for all pending)'
        required: false
        type: string
      dry_run:
        description: 'Perform dry run (no changes)'
        required: false
        type: boolean
        default: true

concurrency:
  group: migration-deploy-${{ github.ref }}-${{ github.event.inputs.environment }}
  cancel-in-progress: false

env:
  NODE_VERSION: '18'

jobs:
  # =====================================================================
  # APPROVAL: Production deployments require manual approval
  # =====================================================================
  approval:
    name: Request Approval
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    environment:
      name: production-approval
    
    steps:
      - name: Production deployment approved
        run: echo "âœ“ Production deployment approved"

  # =====================================================================
  # PRE-DEPLOYMENT: Backup and health checks
  # =====================================================================
  pre-deployment:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    needs: [approval]
    if: always() && (needs.approval.result == 'success' || github.event.inputs.environment == 'staging')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create database backup
        env:
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', github.event.inputs.environment)] }}
        run: |
          echo "Creating database backup..."
          BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
          # In real scenario, use pg_dump
          echo "Backup file would be: $BACKUP_FILE"
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV

      - name: Check database health
        env:
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', github.event.inputs.environment)] }}
        run: |
          echo "Checking database health..."
          node -e "
            const db = require('./backend/src/db-utils');
            db.healthCheck()
              .then(health => {
                if (health.healthy) {
                  console.log('âœ“ Database is healthy');
                } else {
                  console.error('âœ— Database health check failed');
                  process.exit(1);
                }
              })
              .catch(err => {
                console.error('âœ— Health check error:', err.message);
                process.exit(1);
              });
          " || echo "Note: Health check requires backend configuration"

      - name: Verify backup created
        run: |
          echo "âœ“ Backup completed"
          echo "Backup: ${{ env.BACKUP_FILE }}"

  # =====================================================================
  # MIGRATION: Apply migrations to target environment
  # =====================================================================
  deploy:
    name: Deploy Migrations
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: success()
    
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Show migration plan
        env:
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', github.event.inputs.environment)] }}
        run: |
          echo "Migration Plan for: ${{ github.event.inputs.environment }}"
          echo ""
          node ops/migrations/migration_runner.js status || true

      - name: Dry run migrations
        if: github.event.inputs.dry_run == 'true'
        env:
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', github.event.inputs.environment)] }}
          DRY_RUN: 'true'
        run: |
          echo "Performing DRY RUN (no changes will be made)..."
          echo ""
          node -e "
            console.log('This is a dry run. No database changes will be applied.');
            console.log('Migrations that would be executed:');
            const MigrationRunner = require('./ops/migrations/migration_runner');
            const runner = new MigrationRunner();
            const migrations = runner.listMigrations();
            console.log('Pending migrations:');
            migrations.forEach(m => console.log(\`  - \${m}\`));
          " || true

      - name: Apply migrations
        if: github.event.inputs.dry_run == 'false'
        env:
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', github.event.inputs.environment)] }}
        run: |
          echo "Applying migrations to ${{ github.event.inputs.environment }}..."
          echo ""
          
          if [ -z "${{ github.event.inputs.migrations }}" ]; then
            # Run all pending migrations
            node ops/migrations/migration_runner.js pending
          else
            # Run specific migration
            node ops/migrations/migration_runner.js run "${{ github.event.inputs.migrations }}"
          fi

      - name: Verify migration status
        env:
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', github.event.inputs.environment)] }}
        run: |
          echo ""
          echo "Final migration status:"
          node ops/migrations/migration_runner.js status || true

  # =====================================================================
  # POST-DEPLOYMENT: Validation and health checks
  # =====================================================================
  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate database integrity
        env:
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', github.event.inputs.environment)] }}
        run: |
          echo "Validating database integrity..."
          node -e "
            const { Client } = require('pg');
            const client = new Client({ connectionString: process.env.DATABASE_URL });
            
            Promise.resolve()
              .then(() => client.connect())
              .then(() => {
                console.log('âœ“ Database connection successful');
                return client.query('SELECT COUNT(*) as count FROM migrations');
              })
              .then(result => {
                console.log(\`âœ“ \${result.rows[0].count} migrations applied\`);
                return client.query(\`
                  SELECT constraint_name FROM information_schema.table_constraints
                  WHERE table_schema = 'public'
                \`);
              })
              .then(result => {
                console.log(\`âœ“ \${result.rowCount} constraints validated\`);
                return client.end();
              })
              .catch(err => {
                console.error('âœ— Validation failed:', err.message);
                process.exit(1);
              });
          "

      - name: Check application health
        env:
          API_URL: ${{ secrets[format('API_URL_{0}', github.event.inputs.environment)] }}
        run: |
          echo "Checking application health..."
          
          # Wait for API to be ready (with backoff)
          for i in {1..30}; do
            if curl -sf "${{ env.API_URL }}/api/health" > /dev/null 2>&1; then
              echo "âœ“ API health check passed"
              exit 0
            fi
            echo "Attempt $i/30... waiting for API to be ready"
            sleep 2
          done
          
          echo "âš  API health check timed out (this may be OK if API isn't deployed yet)"

  # =====================================================================
  # NOTIFICATION: Report deployment status
  # =====================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, post-deployment]
    if: always()

    steps:
      - name: Generate notification
        run: |
          cat > notification.txt << EOF
          Migration Deployment Report
          
          Environment: ${{ github.event.inputs.environment }}
          Status: ${{ job.status }}
          Dry Run: ${{ github.event.inputs.dry_run }}
          Trigger: Manual
          Triggered By: ${{ github.actor }}
          
          Deployment Status: ${{ needs.deploy.result }}
          Validation Status: ${{ needs.post-deployment.result }}
          EOF
          cat notification.txt

      - name: Slack notification on success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âœ… Migrations Deployed Successfully",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Migrations Deployed Successfully*\n*Environment*: ${{ github.event.inputs.environment }}\n*Triggered by*: ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âŒ Migration Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Migration Deployment Failed*\n*Environment*: ${{ github.event.inputs.environment }}\n*Triggered by*: ${{ github.actor }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create issue on failure
        if: failure() && github.event.inputs.environment == 'production'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Migration Deployment Failed`,
              body: `
              Deployment failed for **${{ github.event.inputs.environment }}** environment.
              
              **Triggered by:** ${{ github.actor }}
              **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              **Time:** ${{ github.event.repository.updated_at }}
              
              Rollback may be required. Please investigate immediately.
              `,
              labels: ['critical', 'migration', 'production']
            })
