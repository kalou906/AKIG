name: ðŸš€ CD Pipeline - Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "frontend/**"
      - "docker-compose.yml"
      - ".github/workflows/cd.yml"

# Timeout global
jobs:
  # ==========================================
  # 1. BUILD (rÃ©utiliser l'artifact de CI)
  # ==========================================
  build:
    name: ðŸ—ï¸  Build & Package
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: ðŸ“¥ Install dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: ðŸ—ï¸  Build frontend
        run: cd frontend && npm run build
        env:
          REACT_APP_API_URL: ${{ secrets.API_URL_PROD }}
          CI: true

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            frontend/build/
            backend/src/
            docker-compose.yml
          retention-days: 1

  # ==========================================
  # 2. DEPLOY TO PRODUCTION
  # ==========================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: ${{ secrets.PRODUCTION_URL }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: ðŸ”‘ Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“‹ Display deployment info
        run: |
          echo "ðŸš€ Deploying to: ${{ secrets.SERVER_HOST }}"
          echo "ðŸ‘¤ User: ${{ secrets.SERVER_USER }}"
          echo "ðŸ“‚ Path: ${{ secrets.DEPLOY_PATH }}"

      - name: ðŸ“¦ Upload code to server
        run: |
          rsync -avz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='dist' \
            -e "ssh -i ~/.ssh/deploy_key" \
            . ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: ðŸ”„ Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main || true
            
            echo "ðŸ³ Building Docker images..."
            docker-compose -f docker-compose.yml pull
            
            echo "ðŸ›‘ Stopping old containers..."
            docker-compose -f docker-compose.yml down || true
            
            echo "ðŸ”„ Starting new containers..."
            docker-compose -f docker-compose.yml up -d postgres
            sleep 5
            
            echo "ðŸ—„ï¸  Running database migrations..."
            docker-compose -f docker-compose.yml exec -T api npm run db:migrate || true
            
            echo "ðŸŒ± Loading seed data..."
            docker-compose -f docker-compose.yml exec -T api npm run db:seed || true
            
            echo "ðŸš€ Starting services..."
            docker-compose -f docker-compose.yml up -d api frontend nginx
            
            echo "âœ… Deployment complete"
            docker-compose ps
          EOF

      - name: ðŸ¥ Health check
        run: |
          echo "ðŸ” Health check..."
          sleep 10
          
          # VÃ©rifier l'API
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/api/health)
          if [ "$API_STATUS" -eq 200 ]; then
            echo "âœ… API healthy (HTTP $API_STATUS)"
          else
            echo "âŒ API unhealthy (HTTP $API_STATUS)"
            exit 1
          fi
          
          # VÃ©rifier le frontend
          WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/)
          if [ "$WEB_STATUS" -eq 200 ]; then
            echo "âœ… Frontend healthy (HTTP $WEB_STATUS)"
          else
            echo "âŒ Frontend unhealthy (HTTP $WEB_STATUS)"
            exit 1
          fi

      - name: ðŸ“§ Deploy notification
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸ“ URL: ${{ secrets.PRODUCTION_URL }}"
          echo "ðŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      - name: ðŸš¨ Rollback on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed. Rolling back..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "ðŸ”„ Rolling back to previous version..."
            git revert HEAD --no-edit || true
            docker-compose -f docker-compose.yml down
            docker-compose -f docker-compose.yml up -d
            
            echo "â®ï¸  Rollback complete"
          EOF
          exit 1

  # ==========================================
  # 3. POST-DEPLOYMENT TESTS
  # ==========================================
  smoke-tests:
    name: ðŸ§ª Smoke Tests (Post-Deploy)
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: ðŸŽ­ Install Playwright
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps chromium

      - name: ðŸ§ª Run smoke tests
        env:
          BASE_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          cd frontend
          npx playwright test tests/dashboard.spec.ts --project=Chromium
          npx playwright test tests/modules.spec.ts --project=Chromium

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: smoke-tests-report
          path: frontend/playwright-report/
          retention-days: 7

  # ==========================================
  # 4. MONITORING & ALERTS
  # ==========================================
  monitoring:
    name: ðŸ“Š Post-Deploy Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ðŸ“Š Monitor server resources
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            echo "ðŸ“Š Server Resources:"
            echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')"
            echo "Memory: $(free -h | awk 'NR==2 {print $3 "/" $2}')"
            echo "Disk: $(df -h / | awk 'NR==2 {print $3 "/" $2}')"
            
            echo ""
            echo "ðŸ³ Docker status:"
            docker ps --format "table {{.Names}}\t{{.Status}}"
            
            echo ""
            echo "ðŸ“‹ Recent logs (API):"
            docker logs --tail 20 akig_api || true
          EOF

      - name: ðŸ“§ Send success notification
        if: success()
        run: |
          echo "âœ… Production deployment successful!"
          echo "ðŸ“ Environment: Production"
          echo "ðŸ”— URL: ${{ secrets.PRODUCTION_URL }}"
          echo "ðŸ• Deploy time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          # Ã€ mettre en place: intÃ©gration Slack/Email/PagerDuty

# ==========================================
# REQUIRED GITHUB SECRETS FOR DEPLOYMENT:
# ==========================================
# - SSH_PRIVATE_KEY: ClÃ© SSH privÃ©e pour dÃ©ploiement
# - SERVER_HOST: Hostname/IP du serveur production
# - SERVER_USER: Utilisateur SSH (ex: deploy)
# - DEPLOY_PATH: Chemin de dÃ©ploiement (ex: /home/deploy/akig)
# - PRODUCTION_URL: URL de la production (ex: https://akig.com)
# - API_URL_PROD: URL API production
# - SNYK_TOKEN: Token Snyk (optionnel)
