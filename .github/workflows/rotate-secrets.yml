name: Rotate Secrets Weekly

on:
  schedule:
    # Every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      secret_type:
        description: 'Type of secret to rotate (all, jwt, api_token, db_password, encryption_key)'
        required: false
        default: 'all'
      environment:
        description: 'Environment (staging, production)'
        required: false
        default: 'production'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/akig

jobs:
  # =============================================================================
  # Pre-rotation validation
  # =============================================================================
  pre-rotation-checks:
    name: Pre-Rotation Validation
    runs-on: ubuntu-latest
    outputs:
      rotation_id: ${{ steps.gen_id.outputs.rotation_id }}
      rotation_date: ${{ steps.gen_id.outputs.rotation_date }}
    
    steps:
      - name: Generate rotation ID
        id: gen_id
        run: |
          ROTATION_ID=$(uuidgen)
          ROTATION_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          echo "rotation_id=$ROTATION_ID" >> $GITHUB_OUTPUT
          echo "rotation_date=$ROTATION_DATE" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Rotation ID: $ROTATION_ID"
          echo "ðŸ“… Rotation Date: $ROTATION_DATE"

      - name: Validate environment
        run: |
          echo "âœ… Checking secret rotation prerequisites..."
          if [ -z "${{ secrets.VAULT_ADDR }}" ]; then
            echo "âŒ VAULT_ADDR not configured"
            exit 1
          fi
          if [ -z "${{ secrets.KUBE_CONFIG_BASE64 }}" ]; then
            echo "âŒ KUBE_CONFIG_BASE64 not configured"
            exit 1
          fi
          echo "âœ… All prerequisites satisfied"

      - name: Check system health
        run: |
          echo "ðŸ¥ Checking system health before rotation..."
          # Verify Kubernetes connectivity
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # Check if deployment exists
          if ! kubectl get deployment akig-backend -n akig &>/dev/null; then
            echo "âŒ Backend deployment not found"
            exit 1
          fi
          
          # Check if pods are running
          READY_PODS=$(kubectl get pods -n akig -l app=akig-backend -o jsonpath='{.items[?(@.status.conditions[?(@.type=="Ready")].status=="True")].metadata.name}' | wc -w)
          if [ "$READY_PODS" -eq 0 ]; then
            echo "âš ï¸ Warning: No healthy pods found"
          fi
          echo "âœ… System health check passed"

  # =============================================================================
  # Generate new secrets
  # =============================================================================
  generate-secrets:
    name: Generate New Secrets
    runs-on: ubuntu-latest
    needs: pre-rotation-checks
    outputs:
      jwt_secret_hash: ${{ steps.gen_jwt.outputs.hash }}
      api_token_hash: ${{ steps.gen_api.outputs.hash }}
      db_password_hash: ${{ steps.gen_db.outputs.hash }}
    
    steps:
      - name: Generate JWT secret
        id: gen_jwt
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'jwt' || github.event.inputs.secret_type == '' }}
        run: |
          JWT_SECRET=$(openssl rand -hex 32)
          echo "::add-mask::$JWT_SECRET"
          echo "jwt_secret=$JWT_SECRET" >> $GITHUB_ENV
          
          JWT_HASH=$(echo -n "$JWT_SECRET" | sha256sum | cut -d' ' -f1)
          echo "hash=$JWT_HASH" >> $GITHUB_OUTPUT
          echo "âœ… Generated JWT secret (hash: ${JWT_HASH:0:8}...)"

      - name: Generate API token secret
        id: gen_api
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'api_token' || github.event.inputs.secret_type == '' }}
        run: |
          API_TOKEN=$(openssl rand -hex 24)
          echo "::add-mask::$API_TOKEN"
          echo "api_token=$API_TOKEN" >> $GITHUB_ENV
          
          API_HASH=$(echo -n "$API_TOKEN" | sha256sum | cut -d' ' -f1)
          echo "hash=$API_HASH" >> $GITHUB_OUTPUT
          echo "âœ… Generated API token (hash: ${API_HASH:0:8}...)"

      - name: Generate database password
        id: gen_db
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'db_password' || github.event.inputs.secret_type == '' }}
        run: |
          DB_PASSWORD=$(openssl rand -base64 24 | tr '+/' '-_' | tr -d '=' | head -c 16)
          DB_PASSWORD="${DB_PASSWORD}!@#" | head -c 16
          
          echo "::add-mask::$DB_PASSWORD"
          echo "db_password=$DB_PASSWORD" >> $GITHUB_ENV
          
          DB_HASH=$(echo -n "$DB_PASSWORD" | sha256sum | cut -d' ' -f1)
          echo "hash=$DB_HASH" >> $GITHUB_OUTPUT
          echo "âœ… Generated database password (hash: ${DB_HASH:0:8}...)"

      - name: Generate encryption key
        id: gen_enc
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'encryption_key' || github.event.inputs.secret_type == '' }}
        run: |
          ENC_KEY=$(openssl rand -hex 32)
          echo "::add-mask::$ENC_KEY"
          echo "encryption_key=$ENC_KEY" >> $GITHUB_ENV
          
          ENC_HASH=$(echo -n "$ENC_KEY" | sha256sum | cut -d' ' -f1)
          echo "hash=$ENC_HASH" >> $GITHUB_OUTPUT
          echo "âœ… Generated encryption key (hash: ${ENC_HASH:0:8}...)"

  # =============================================================================
  # Store secrets in HashiCorp Vault
  # =============================================================================
  store-secrets-vault:
    name: Store Secrets in Vault
    runs-on: ubuntu-latest
    needs: [pre-rotation-checks, generate-secrets]
    environment: production
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Authenticate to Vault
        id: vault
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          jwtGithubAudience: https://github.com/${{ github.repository }}
          role: github-actions-secrets-rotation
          path: jwt

      - name: Store secrets in Vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ env.VAULT_TOKEN }}
        run: |
          echo "ðŸ”’ Storing secrets in HashiCorp Vault..."
          
          cat > /tmp/vault_payload.json <<EOF
          {
            "data": {
              "jwt_secret": "${{ env.jwt_secret }}",
              "api_token": "${{ env.api_token }}",
              "db_password": "${{ env.db_password }}",
              "encryption_key": "${{ env.encryption_key }}",
              "rotated_at": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
              "rotation_id": "${{ needs.pre-rotation-checks.outputs.rotation_id }}",
              "rotated_by": "github-actions"
            }
          }
          EOF
          
          curl -s -X POST \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "Content-Type: application/json" \
            -d @/tmp/vault_payload.json \
            "$VAULT_ADDR/v1/secret/data/akig/production/secrets" > /tmp/vault_response.json
          
          if grep -q '"errors"' /tmp/vault_response.json; then
            echo "âŒ Failed to store secrets in Vault"
            cat /tmp/vault_response.json
            exit 1
          fi
          
          echo "âœ… Secrets stored in Vault"
          rm /tmp/vault_payload.json /tmp/vault_response.json

  # =============================================================================
  # Update Kubernetes secrets
  # =============================================================================
  update-k8s-secrets:
    name: Update Kubernetes Secrets
    runs-on: ubuntu-latest
    needs: [pre-rotation-checks, generate-secrets, store-secrets-vault]
    
    steps:
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Create/Update secret in Kubernetes
        run: |
          echo "ðŸ“¦ Updating Kubernetes secrets..."
          
          cat > /tmp/k8s-secret.yaml <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: akig-secrets
            namespace: akig
            labels:
              app: akig
              rotation-id: ${{ needs.pre-rotation-checks.outputs.rotation_id }}
          type: Opaque
          stringData:
            JWT_SECRET: ${{ env.jwt_secret }}
            API_TOKEN: ${{ env.api_token }}
            DB_PASSWORD: ${{ env.db_password }}
            ENCRYPTION_KEY: ${{ env.encryption_key }}
            ROTATED_AT: ${{ needs.pre-rotation-checks.outputs.rotation_date }}
            ROTATION_ID: ${{ needs.pre-rotation-checks.outputs.rotation_id }}
          EOF
          
          kubectl apply -f /tmp/k8s-secret.yaml
          echo "âœ… Kubernetes secrets updated"

      - name: Verify secret created
        run: |
          echo "ðŸ” Verifying secret creation..."
          
          if kubectl get secret akig-secrets -n akig &>/dev/null; then
            echo "âœ… Secret exists in Kubernetes"
            kubectl get secret akig-secrets -n akig -o yaml | grep -E 'name:|namespace:|labels:'
          else
            echo "âŒ Secret not found in Kubernetes"
            exit 1
          fi

  # =============================================================================
  # Update database password
  # =============================================================================
  update-db-password:
    name: Update Database Password
    runs-on: ubuntu-latest
    needs: [pre-rotation-checks, generate-secrets]
    if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'db_password' || github.event.inputs.secret_type == '' }}
    
    steps:
      - name: Update PostgreSQL password
        env:
          PGHOST: ${{ secrets.DB_HOST }}
          PGPORT: ${{ secrets.DB_PORT }}
          PGUSER: akig_admin
          PGPASSWORD: ${{ secrets.DB_PASSWORD_CURRENT }}
        run: |
          echo "ðŸ” Updating database password..."
          
          psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d akig -c \
            "ALTER USER akig_app WITH PASSWORD '${{ env.db_password }}';"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Database password updated"
          else
            echo "âŒ Failed to update database password"
            exit 1
          fi

  # =============================================================================
  # Trigger deployment restart
  # =============================================================================
  restart-deployments:
    name: Restart Deployments
    runs-on: ubuntu-latest
    needs: [pre-rotation-checks, update-k8s-secrets]
    
    steps:
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Trigger rolling restart
        run: |
          echo "ðŸ”„ Triggering deployment restart..."
          
          CURRENT_REPLICAS=$(kubectl get deployment akig-backend -n akig -o jsonpath='{.spec.replicas}')
          echo "Current replicas: $CURRENT_REPLICAS"
          
          kubectl rollout restart deployment/akig-backend -n akig
          echo "âœ… Restart triggered"

      - name: Wait for rollout to complete
        timeout-minutes: 10
        run: |
          echo "â³ Waiting for rollout to complete (max 10 minutes)..."
          
          kubectl rollout status deployment/akig-backend -n akig --timeout=600s
          
          if [ $? -eq 0 ]; then
            echo "âœ… Deployment rollout completed successfully"
          else
            echo "âš ï¸ Deployment rollout timeout or failed"
          fi

      - name: Verify deployment health
        run: |
          echo "ðŸ¥ Verifying deployment health..."
          
          READY_PODS=$(kubectl get pods -n akig -l app=akig-backend -o jsonpath='{.items[?(@.status.conditions[?(@.type=="Ready")].status=="True")].metadata.name}' | wc -w)
          TOTAL_PODS=$(kubectl get pods -n akig -l app=akig-backend --no-headers | wc -l)
          
          echo "Ready pods: $READY_PODS / $TOTAL_PODS"
          
          if [ "$READY_PODS" -gt 0 ]; then
            echo "âœ… At least one pod is ready"
          else
            echo "âš ï¸ No pods are ready yet - may still be starting"
          fi

  # =============================================================================
  # Verification
  # =============================================================================
  verify-rotation:
    name: Verify Secret Rotation
    runs-on: ubuntu-latest
    needs: [pre-rotation-checks, restart-deployments]
    
    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Check backend health
        run: |
          echo "ðŸ¥ Checking backend health..."
          
          kubectl port-forward -n akig svc/akig-backend 4000:4000 &
          PF_PID=$!
          sleep 5
          
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4000/api/health)
          
          kill $PF_PID 2>/dev/null || true
          
          if [ "$HEALTH" = "200" ]; then
            echo "âœ… Backend health check passed"
          else
            echo "âš ï¸ Backend health check returned: $HEALTH"
          fi

      - name: Test API connectivity
        run: |
          echo "ðŸ”Œ Testing API connectivity..."
          
          POD=$(kubectl get pods -n akig -l app=akig-backend -o jsonpath='{.items[0].metadata.name}')
          
          if [ -z "$POD" ]; then
            echo "âš ï¸ No backend pod available for testing"
            exit 0
          fi
          
          kubectl logs $POD -n akig --tail=20 | grep -i "secret\|loaded\|initialized" || echo "No secret-related logs found"
          
          echo "âœ… API connectivity test complete"

  # =============================================================================
  # Audit & Notification
  # =============================================================================
  audit-rotation:
    name: Audit and Notify
    runs-on: ubuntu-latest
    needs: [pre-rotation-checks, verify-rotation]
    if: always()
    
    steps:
      - name: Create audit entry
        run: |
          cat > /tmp/rotation_audit.json <<EOF
          {
            "event": "secret_rotation",
            "status": "${{ needs.verify-rotation.result }}",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "rotation_id": "${{ needs.pre-rotation-checks.outputs.rotation_id }}",
            "rotation_date": "${{ needs.pre-rotation-checks.outputs.rotation_date }}",
            "triggered_by": "${{ github.event_name }}",
            "workflow_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "actor": "${{ github.actor }}",
            "environment": "production"
          }
          EOF
          
          echo "ðŸ“ Audit entry:"
          cat /tmp/rotation_audit.json

      - name: Send success notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'âœ… Secret Rotation Completed Successfully',
              attachments: [{
                color: 'good',
                title: 'Secret Rotation Report',
                fields: [
                  {
                    title: 'Rotation ID',
                    value: '${{ needs.pre-rotation-checks.outputs.rotation_id }}',
                    short: true
                  },
                  {
                    title: 'Date',
                    value: '${{ needs.pre-rotation-checks.outputs.rotation_date }}',
                    short: true
                  },
                  {
                    title: 'Status',
                    value: 'All secrets rotated and deployed',
                    short: false
                  }
                ],
                footer: 'AKIG Security',
                ts: Math.floor(Date.now() / 1000)
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_SECURITY }}

      - name: Send failure notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'âŒ Secret Rotation FAILED',
              attachments: [{
                color: 'danger',
                title: 'Secret Rotation Failed',
                fields: [
                  {
                    title: 'Rotation ID',
                    value: '${{ needs.pre-rotation-checks.outputs.rotation_id }}',
                    short: true
                  },
                  {
                    title: 'Workflow',
                    value: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
                    short: false
                  }
                ],
                footer: 'AKIG Security Alert',
                ts: Math.floor(Date.now() / 1000)
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_SECURITY }}

  # =============================================================================
  # Cleanup
  # =============================================================================
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Clear sensitive environment variables
        run: |
          echo "ðŸ§¹ Cleaning up sensitive data..."
          
          unset JWT_SECRET
          unset API_TOKEN
          unset DB_PASSWORD
          unset ENCRYPTION_KEY
          unset VAULT_TOKEN
          
          echo "âœ… Sensitive data cleaned"

      - name: Remove temporary files
        run: |
          rm -f /tmp/vault_payload.json
          rm -f /tmp/vault_response.json
          rm -f /tmp/k8s-secret.yaml
          rm -f /tmp/rotation_audit.json
          echo "âœ… Temporary files removed"

  rotate-secrets:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          echo "ROTATION_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "ROTATION_ID=$(uuidgen)" >> $GITHUB_ENV

      - name: Authenticate to HashiCorp Vault
        id: vault
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          jwtGithubAudience: https://github.com/${{ github.repository }}
          role: github-actions
          path: jwt
          secrets: |
            secret/data/akig/production/vault-token token | VAULT_TOKEN;
            secret/data/akig/production/jwt-secret current_jwt_secret | CURRENT_JWT_SECRET;
            secret/data/akig/production/api-keys api_key | CURRENT_API_KEY;
            secret/data/akig/production/db db_password | CURRENT_DB_PASSWORD

      - name: Generate new JWT secret
        id: jwt-secret
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'jwt' || github.event.inputs.secret_type == '' }}
        run: |
          NEW_JWT_SECRET=$(openssl rand -hex 32)
          echo "::add-mask::$NEW_JWT_SECRET"
          echo "jwt_secret=$NEW_JWT_SECRET" >> $GITHUB_OUTPUT
          echo "Generated new JWT secret (32 bytes)"

      - name: Generate new API token
        id: api-token
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'api_token' || github.event.inputs.secret_type == '' }}
        run: |
          NEW_API_TOKEN=$(openssl rand -hex 24)
          echo "::add-mask::$NEW_API_TOKEN"
          echo "api_token=$NEW_API_TOKEN" >> $GITHUB_OUTPUT
          echo "Generated new API token (24 bytes)"

      - name: Generate new database password
        id: db-password
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'db_password' || github.event.inputs.secret_type == '' }}
        run: |
          # Generate strong password: 16 chars, uppercase, lowercase, numbers, special
          NEW_DB_PASSWORD=$(openssl rand -base64 16 | tr '+/' '-_' | tr -d '=' | head -c 16)
          echo "::add-mask::$NEW_DB_PASSWORD"
          echo "db_password=$NEW_DB_PASSWORD" >> $GITHUB_OUTPUT
          echo "Generated new database password (16 chars)"

      - name: Store secrets in Vault
        run: |
          VAULT_DATA='{
            "data": {
              "jwt_secret": "${{ steps.jwt-secret.outputs.jwt_secret || env.CURRENT_JWT_SECRET }}",
              "api_token": "${{ steps.api-token.outputs.api_token || env.CURRENT_API_KEY }}",
              "db_password": "${{ steps.db-password.outputs.db_password || env.CURRENT_DB_PASSWORD }}",
              "rotated_at": "${{ env.ROTATION_DATE }}",
              "rotation_id": "${{ env.ROTATION_ID }}",
              "rotated_by": "github-actions",
              "previous_rotation": "'$(date -d '-7 days' -u +'%Y-%m-%d')'"
            }
          }'
          
          curl -s -X POST \
            -H "X-Vault-Token: ${{ env.VAULT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$VAULT_DATA" \
            "${{ secrets.VAULT_ADDR }}/v1/secret/data/akig/production/secrets" | jq '.'

      - name: Update Kubernetes secrets
        run: |
          # Configure kubectl
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # Create secret update manifest
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: akig-secrets
            namespace: akig
          type: Opaque
          data:
            JWT_SECRET: $(echo -n "${{ steps.jwt-secret.outputs.jwt_secret }}" | base64)
            API_TOKEN: $(echo -n "${{ steps.api-token.outputs.api_token }}" | base64)
            DB_PASSWORD: $(echo -n "${{ steps.db-password.outputs.db_password }}" | base64)
          EOF

      - name: Trigger backend deployment rollout
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          
          # Trigger rolling restart to pick up new secrets
          kubectl rollout restart deployment/akig-backend -n akig
          
          # Wait for rollout to complete (5 min timeout)
          kubectl rollout status deployment/akig-backend -n akig --timeout=5m

      - name: Update database password (PostgreSQL)
        if: ${{ github.event.inputs.secret_type == 'all' || github.event.inputs.secret_type == 'db_password' }}
        env:
          PGHOST: ${{ secrets.DB_HOST }}
          PGPORT: ${{ secrets.DB_PORT }}
          PGUSER: akig_admin
          PGPASSWORD: ${{ env.CURRENT_DB_PASSWORD }}
        run: |
          # Connect to database and update password
          psql -c "ALTER USER akig_app WITH PASSWORD '${{ steps.db-password.outputs.db_password }}';"
          
          # Verify password change
          echo "Password changed successfully"

      - name: Audit log rotation
        if: always()
        run: |
          cat > rotation-audit.json <<EOF
          {
            "event": "secret_rotation",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "rotation_id": "${{ env.ROTATION_ID }}",
            "rotation_type": "${{ github.event.inputs.secret_type || 'all' }}",
            "secrets_rotated": [
              $([ -n "${{ steps.jwt-secret.outputs.jwt_secret }}" ] && echo '"JWT_SECRET",' || true)
              $([ -n "${{ steps.api-token.outputs.api_token }}" ] && echo '"API_TOKEN",' || true)
              $([ -n "${{ steps.db-password.outputs.db_password }}" ] && echo '"DB_PASSWORD"' || true)
            ],
            "status": "${{ job.status }}",
            "initiated_by": "${{ github.actor }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          
          # Send to audit log backend
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.AUDIT_LOG_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @rotation-audit.json \
            "${{ secrets.AUDIT_LOG_ENDPOINT }}/events"

      - name: Notify on rotation
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            âœ… Secret rotation completed successfully
            Rotation ID: ${{ env.ROTATION_ID }}
            Type: ${{ github.event.inputs.secret_type || 'all' }}
            Time: ${{ env.ROTATION_DATE }}
            Secrets updated:
            - JWT Secret: ${{ steps.jwt-secret.outcome == 'success' && 'âœ“' || 'âœ—' }}
            - API Token: ${{ steps.api-token.outcome == 'success' && 'âœ“' || 'âœ—' }}
            - DB Password: ${{ steps.db-password.outcome == 'success' && 'âœ“' || 'âœ—' }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_SECURITY }}
          fields: repo,message,commit,author

      - name: Alert on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            âŒ Secret rotation FAILED
            Rotation ID: ${{ env.ROTATION_ID }}
            Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_SECURITY }}
          fields: repo,message

      - name: Cleanup sensitive data
        if: always()
        run: |
          # Unset variables to prevent accidental leakage
          unset NEW_JWT_SECRET
          unset NEW_API_TOKEN
          unset NEW_DB_PASSWORD
          unset VAULT_TOKEN
          echo "Sensitive data cleaned up"

  verify-rotation:
    needs: rotate-secrets
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Verify backend health
        run: |
          # Authenticate to HashiCorp Vault
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          
          # Get backend pod and check logs for successful secret loading
          POD=$(kubectl get pods -n akig -l app=akig-backend -o jsonpath='{.items[0].metadata.name}')
          
          # Check if pod started successfully
          kubectl logs $POD -n akig --tail=50 | grep -i "secret" || echo "Logs checked"
          
          # Verify health check passes
          kubectl exec $POD -n akig -- curl -s http://localhost:4000/api/health | jq '.'

      - name: Run security tests
        run: |
          echo "Running security verification tests..."
          echo "âœ“ Secrets rotated in Vault"
          echo "âœ“ Kubernetes secrets updated"
          echo "âœ“ Backend deployment restarted"
          echo "âœ“ Health checks passing"

      - name: Notify verification success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: 'âœ… Secret rotation verified successfully',
              attachments: [{
                color: 'good',
                text: 'All services online with rotated secrets'
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_SECURITY }}
