# =============================================================================
# ModSecurity CRS (Core Rule Set) Setup Configuration
# =============================================================================
# Configuration for OWASP ModSecurity Core Rule Set

# =============================================================================
# 1. RULE SET INITIALIZATION
# =============================================================================

# Define your content types
SecContentInjectionEnabled Off
SecStreamInBodyInspection Off

# =============================================================================
# 2. DEFAULT ACTIONS
# =============================================================================

SecDefaultAction "phase:1,log,nolog,pass"
SecDefaultAction "phase:2,log,nolog,pass"
SecDefaultAction "phase:3,log,nolog,pass"
SecDefaultAction "phase:4,log,nolog,pass"
SecDefaultAction "phase:5,log,nolog,pass"

# =============================================================================
# 3. PARANOIA LEVEL CONFIGURATION
# =============================================================================

# Paranoia Level 1: Low sensitivity (default)
# Paranoia Level 2: Medium sensitivity
# Paranoia Level 3: High sensitivity
# Paranoia Level 4: Extreme (may cause false positives)
SecAction \
  "id:900000,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.paranoia_level=2"

# =============================================================================
# 4. EXECUTION LEVEL
# =============================================================================

# Engine: Execution engine mode
SecAction \
  "id:900010,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.crs_validate_utf8_encoding=1,\
  setvar:tx.allowed_methods=GET|HEAD|POST|PUT|DELETE|OPTIONS|PATCH,\
  setvar:tx.allowed_http_versions=HTTP/1.0|HTTP/1.1|HTTP/2.0,\
  setvar:tx.restricted_extensions=.asa/.cer/.ado/.asp/.aspx/.bat/.chm/.cmd/.com/.cpl/.crt/.dll/.dob/.exe/.hta/.inf/.ins/.isp/.jse/.htaccess/.mdb/.mde/.msc/.msi/.msp/.mst/.ops/.pif/.prf/.reg/.scr/.shs/.shb/.sys/.vbs/.vxd/.wsc/.wsf/.wsh,\
  setvar:tx.restricted_headers=/Accept-Encoding|Content-Encoding|Content-MD5|Content-Range|Content-Type|Content-Length|If-Match|If-Modified-Since|If-None-Match|If-Range|If-Unmodified-Since|Range|Transfer-Encoding|Authorization/"

# =============================================================================
# 5. ANOMALY SCORING THRESHOLDS
# =============================================================================

SecAction \
  "id:900100,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.inbound_anomaly_score_pl1=8,\
  setvar:tx.inbound_anomaly_score_pl2=5,\
  setvar:tx.inbound_anomaly_score_pl3=4,\
  setvar:tx.inbound_anomaly_score_pl4=2,\
  setvar:tx.outbound_anomaly_score_threshold=4,\
  setvar:tx.outbound_anomaly_score_pl1=5,\
  setvar:tx.outbound_anomaly_score_pl2=4,\
  setvar:tx.outbound_anomaly_score_pl3=3,\
  setvar:tx.outbound_anomaly_score_pl4=2"

# =============================================================================
# 6. APPLICATION SPECIFIC SETTINGS
# =============================================================================

SecAction \
  "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.blocking_paranoia_level=2,\
  setvar:tx.detection_paranoia_level=2,\
  setvar:tx.http_violation_score_threshold=5,\
  setvar:tx.protocol_violation_score_threshold=5,\
  setvar:tx.lfi_score_threshold=5,\
  setvar:tx.rfi_score_threshold=5,\
  setvar:tx.rce_score_threshold=5,\
  setvar:tx.php_injection_score_threshold=5,\
  setvar:tx.xss_score_threshold=5,\
  setvar:tx.sql_injection_score_threshold=5,\
  setvar:tx.evaded_sql_injection_score_threshold=5,\
  setvar:tx.ldap_injection_score_threshold=5"

# =============================================================================
# 7. REQUEST BODY HANDLING
# =============================================================================

SecAction \
  "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.max_body_size=10485760,\
  setvar:tx.max_file_size=5242880"

# =============================================================================
# 8. MULTIPART/FORM-DATA HANDLING
# =============================================================================

SecAction \
  "id:900210,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.allow_multiple_content_length_checks=0,\
  setvar:tx.allow_multiple_transfer_encoding_checks=0"

# =============================================================================
# 9. ENCODING SETTINGS
# =============================================================================

SecAction \
  "id:900220,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.charset_default=utf-8,\
  setvar:tx.charset_iso_8859_1=iso-8859-1"

# =============================================================================
# 10. COOKIE SETTINGS
# =============================================================================

SecAction \
  "id:900230,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.cookie_format=0,\
  setvar:tx.cookie_v0_separator=;,\
  setvar:tx.cookie_v1_separator=;"

# =============================================================================
# 11. ARGUMENT SEPARATION
# =============================================================================

SecAction \
  "id:900240,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.arg_separator=&"

# =============================================================================
# 12. RESPONSE BODY HANDLING
# =============================================================================

SecAction \
  "id:900250,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.response_inspection_enabled=0"

# =============================================================================
# 13. UNICODE SETTINGS
# =============================================================================

SecAction \
  "id:900260,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.unicode_mapping_table=unicode.mapping"

# =============================================================================
# 14. URL ENCODING
# =============================================================================

SecAction \
  "id:900270,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.url_encoding_check=1"

# =============================================================================
# 15. PERFORMANCE SETTINGS
# =============================================================================

SecAction \
  "id:900280,\
  phase:1,\
  nolog,\
  pass,\
  setvar:tx.collection_timeout=600"

# =============================================================================
# 16. CUSTOM EXCLUSIONS FOR AKIG
# =============================================================================

# Exclude health check endpoint
SecRule REQUEST_URI "@eq /health" \
  "id:900300,\
  phase:1,\
  nolog,\
  pass,\
  ctl:ruleEngine=Off"

# Exclude metrics endpoint from inspection
SecRule REQUEST_URI "@beginsWith /metrics" \
  "id:900310,\
  phase:1,\
  nolog,\
  pass,\
  ctl:ruleEngine=DetectionOnly"

# Exclude specific JWT validation rules for auth endpoints
SecRule REQUEST_URI "@rx ^/api/auth" \
  "id:900320,\
  phase:2,\
  nolog,\
  pass,\
  ctl:ruleRemoveById=942220-942230"

# =============================================================================
# 17. RULE TUNING
# =============================================================================

# Disable specific CRS rules that may cause false positives
# SecRuleRemoveById 942251  # SQL injection - may need tuning
# SecRuleRemoveById 942420  # SQL injection - character restriction
# SecRuleRemoveById 930100  # Path traversal - may need tuning

# =============================================================================
# 18. RULE CHAINING CONFIGURATION
# =============================================================================

SecChainRule on

# =============================================================================
# 19. PHASE EXECUTION
# =============================================================================

# Phase 1: Request headers
# Phase 2: Request body
# Phase 3: Response headers
# Phase 4: Response body
# Phase 5: Logging
