# =============================================================================
# ModSecurity Configuration
# =============================================================================
# Main ModSecurity rules engine configuration file
# Enables OWASP Core Rule Set and custom rules for AKIG

# Basic configuration
SecRuleEngine On
SecRequestBodyAccess On
SecRequestBodyLimit 10485760
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction ProcessPartial
SecResponseBodyAccess Off

# File uploads
SecTmpDir /tmp/
SecDataDir /tmp/

# Logging
SecAuditEngine On
SecAuditLogRelevantStatus "^(?:4|5)"
SecAuditLogParts ABCDEFGHIJKZ
SecAuditLogFormat JSON

# Data storage
SecCollectionTimeout 600

# Disable some rules for legitimate traffic
SecRuleRemoveById 200003

# Include OWASP Core Rule Set (if installed)
Include /etc/nginx/modsec/crs-setup.conf
Include /etc/nginx/modsec/rules/*.conf

# =============================================================================
# AKIG Custom Rules
# =============================================================================

# Require JWT token for sensitive endpoints
SecRule REQUEST_URI "@rx ^/api/(payments|contracts|admin)" \
  "chain,id:1001,phase:2,deny,status:401,msg:'JWT authentication required'"
  SecRule REQUEST_HEADERS:Authorization "!@rx ^Bearer\s" \
    "id:1002"

# Block requests with suspicious content-type
SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
  "chain,id:1003,phase:1,deny,status:415,msg:'Invalid Content-Type'"
  SecRule REQUEST_HEADERS:Content-Type "!@rx ^(application/json|multipart/form-data|application/x-www-form-urlencoded)"

# Rate limit: max 100 requests per minute per IP
SecRule IP:@collection "^(?P<limit>\d+)$" \
  "id:1004,phase:2,chain,msg:'Rate limit exceeded'"
  SecRule &IP:@collection "!@isLessThan 100"

# Block SQL injection patterns
SecRule ARGS:id "(?:union|select|insert|delete|update|drop|exec|script)" \
  "id:1005,phase:2,deny,status:403,msg:'SQL injection attempt'"

# Block path traversal attempts
SecRule REQUEST_URI_RAW "@rx \.\./|\.\.\\\\|%2e%2e|\.\.%2f" \
  "id:1006,phase:1,deny,status:403,msg:'Path traversal attempt'"

# Block XXE attacks
SecRule REQUEST_BODY "@rx <!DOCTYPE|<!ENTITY|SYSTEM" \
  "id:1007,phase:2,deny,status:403,msg:'XXE attack attempt'"

# Block LDAP injection
SecRule ARGS "@rx \(\*|\\\\|&|\|" \
  "id:1008,phase:2,deny,status:403,msg:'LDAP injection attempt'"

# Block command injection
SecRule ARGS "@rx \$\(|`|;|&&|\|\||>|<|cmd=|exec=" \
  "id:1009,phase:2,deny,status:403,msg:'Command injection attempt'"

# Require Content-Length for POST/PUT requests
SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
  "chain,id:1010,phase:1,deny,status:411,msg:'Missing Content-Length'"
  SecRule &REQUEST_HEADERS:Content-Length "@eq 0"

# Block oversized request bodies for auth endpoints
SecRule REQUEST_URI "@rx ^/api/auth" \
  "chain,id:1011,phase:1,deny,status:413,msg:'Request too large'"
  SecRule CONTENT_LENGTH "@gt 10240"

# Audit suspicious file uploads
SecRule REQUEST_URI "@rx ^/api/(invoices|contracts)/upload" \
  "chain,id:1012,phase:2,log,msg:'File upload detected'"
  SecRule REQUEST_HEADERS:Content-Type "!@rx ^(image/|application/pdf)"

# Block suspicious user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (sqlmap|nikto|nmap|masscan)" \
  "id:1013,phase:1,deny,status:403,msg:'Malicious bot detected'"

# Require valid Accept header format
SecRule REQUEST_HEADERS:Accept "!@rx ^application/(json|.*\+json)" \
  "id:1014,phase:1,msg:'Invalid Accept header'"

# Prevent request smuggling
SecRule REQUEST_HEADERS:Transfer-Encoding "!@streq chunked" \
  "id:1015,phase:1,chain,msg:'Request smuggling attempt'"
  SecRule REQUEST_HEADERS_NAMES "@rx Content-Length" \
    "id:1016"

# Block null byte injection
SecRule REQUEST_URI "@rx %00" \
  "id:1017,phase:1,deny,status:403,msg:'Null byte injection'"

# =========================================================================
# Payment Security Rules
# =========================================================================

# Validate payment amount format
SecRule REQUEST_URI "@rx ^/api/payments" \
  "chain,id:2001,phase:3,msg:'Invalid payment amount'"
  SecRule RESPONSE_HEADERS:Content-Type "@rx application/json"

# Rate limit payment creation
SecRule REQUEST_URI "@rx ^/api/payments$" \
  "id:2002,phase:2,chain,msg:'Payment creation rate limited',nolog"
  SecRule REQUEST_METHOD "@eq POST"

# Require invoice reference for payments
SecRule REQUEST_URI "@rx ^/api/payments" \
  "chain,id:2003,phase:2,msg:'Missing invoice reference'"
  SecRule REQUEST_METHOD "@eq POST"

# =========================================================================
# Authentication Security Rules
# =========================================================================

# Prevent account enumeration
SecRule REQUEST_URI "@rx ^/api/auth/(login|register)" \
  "id:3001,phase:2,nolog,msg:'Auth attempt'"

# Limit failed login attempts per IP
SecRule IP:failed_logins "@gt 5" \
  "id:3002,phase:2,deny,status:429,msg:'Too many failed login attempts'"

# Block weak passwords
SecRule REQUEST_BODY "@rx \"password\":\s*\"(.{0,7})\"" \
  "id:3003,phase:2,deny,status:400,msg:'Password too weak'"

# Enforce HTTPS for auth requests
SecRule REQUEST_URI "@rx ^/api/auth" \
  "chain,id:3004,phase:1,deny,status:403,msg:'Auth over HTTP'"
  SecRule HTTPS "@streq off"

# =========================================================================
# Data Protection Rules
# =========================================================================

# Prevent leakage of internal server headers
SecRule RESPONSE_HEADERS:X-Powered-By \
  "id:4001,phase:3,msg:'Internal software revealed'"

# Prevent sensitive data exposure
SecRule RESPONSE_BODY "@rx (password|credit_card|ssn|token)" \
  "id:4002,phase:3,msg:'Sensitive data in response'"

# Validate JSON responses
SecRule RESPONSE_HEADERS:Content-Type "@rx application/json" \
  "chain,id:4003,phase:3,msg:'Invalid JSON response'"
  SecRule RESPONSE_BODY "!@rx ^\{.*\}$"

# =========================================================================
# DDoS Protection Rules
# =========================================================================

# Detect HTTP floods
SecAction \
  "id:5001,phase:1,setvar:ip.req_count=+1"

SecRule IP:req_count "@gt 1000" \
  "id:5002,phase:1,deny,status:503,msg:'HTTP flood detected'"

# Detect slowloris attacks
SecRule RESPONSE_TIME "@gt 30000" \
  "id:5003,phase:3,msg:'Slow response detected (possible slowloris)'"

# =========================================================================
# Alerting
# ==========================================================================

# Log all blocked requests
SecRule ACTION "id" \
  "id:9001,phase:3,log,msg:'Request blocked by ModSecurity'"
