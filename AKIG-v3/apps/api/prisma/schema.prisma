generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex", "postgresqlExtensions", "views", "metrics"]
  binaryTargets   = ["native", "linux-musl", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm, pg_stat_statements, timescaledb]
}

// ================== ENUMS ==================

enum UserRole {
  ADMIN
  MANAGER
  AGENT
  COMPTABLE
  VIEWER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CHECK
  MOBILE_MONEY
  ORANGE_MONEY
  MTN_MONEY
  STRIPE
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PropertyType {
  APARTMENT
  HOUSE
  VILLA
  COMMERCIAL
  LAND
  OFFICE
  WAREHOUSE
}

enum MaintenanceStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  CANCELLED
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  AI_PREDICTION
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  PAYMENT_PROCESS
  CONTRACT_SIGN
  AI_PREDICTION
}

// ================== MODELS ==================

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  passwordHash      String         @map("password_hash")
  name              String
  phone             String?
  avatar            String?
  role              UserRole       @default(AGENT)
  status            UserStatus     @default(ACTIVE)
  emailVerified     Boolean        @default(false) @map("email_verified")
  emailVerifiedAt   DateTime?      @map("email_verified_at")
  twoFactorEnabled  Boolean        @default(false) @map("two_factor_enabled")
  twoFactorSecret   String?        @map("two_factor_secret")
  lastLoginAt       DateTime?      @map("last_login_at")
  lastLoginIp       String?        @map("last_login_ip")
  metadata          Json?          @db.JsonB
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  deletedAt         DateTime?      @map("deleted_at")

  // Relations
  properties        Property[]
  contracts         Contract[]     @relation("ContractCreatedBy")
  payments          Payment[]      @relation("PaymentCreatedBy")
  auditLogs         AuditLog[]
  sessions          Session[]
  notifications     Notification[]
  agentProfile      AgentProfile?
  createdTenants    Tenant[]       @relation("TenantCreatedBy")

  @@index([email])
  @@index([role, status])
  @@index([createdAt])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  tokenHash    String   @unique @map("token_hash")
  deviceInfo   String?  @map("device_info")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model AgentProfile {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  zone            String?
  commission      Float    @default(0)
  score           Int      @default(0)
  monthlyGoal     Float    @default(0) @map("monthly_goal")
  badges          Json?    @db.JsonB
  performanceData Json?    @db.JsonB @map("performance_data")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("agent_profiles")
}

model Tenant {
  id                String     @id @default(cuid())
  name              String
  email             String?
  phone             String
  idNumber          String?    @map("id_number")
  occupation        String?
  monthlyIncome     Float?     @map("monthly_income")
  creditScore       Int?       @map("credit_score")
  emergencyContact  Json?      @db.JsonB @map("emergency_contact")
  notes             String?
  riskScore         Float?     @map("risk_score") // Calculé par IA
  lastRiskUpdate    DateTime?  @map("last_risk_update")
  metadata          Json?      @db.JsonB
  createdById       String     @map("created_by_id")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  deletedAt         DateTime?  @map("deleted_at")

  contracts         Contract[]
  payments          Payment[]
  maintenanceTickets MaintenanceTicket[]
  createdBy         User       @relation("TenantCreatedBy", fields: [createdById], references: [id])

  @@index([email])
  @@index([phone])
  @@index([riskScore])
  @@index([createdAt])
  @@map("tenants")
}

model Property {
  id               String       @id @default(cuid())
  title            String
  description      String?
  address          String
  city             String
  country          String       @default("Guinea")
  postalCode       String?      @map("postal_code")
  type             PropertyType
  surface          Float?       // m²
  rooms            Int?
  bathrooms        Int?
  floor            Int?
  totalFloors      Int?         @map("total_floors")
  parkingSpaces    Int?         @map("parking_spaces")
  furnished        Boolean      @default(false)
  features         Json?        @db.JsonB
  images           Json?        @db.JsonB
  documents        Json?        @db.JsonB
  coordinates      Json?        @db.JsonB // {lat, lng}
  ownerId          String       @map("owner_id")
  metadata         Json?        @db.JsonB
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  deletedAt        DateTime?    @map("deleted_at")

  owner            User         @relation(fields: [ownerId], references: [id])
  contracts        Contract[]
  maintenanceTickets MaintenanceTicket[]

  @@index([city, type])
  @@index([ownerId])
  @@index([createdAt])
  @@map("properties")
}

model Contract {
  id                String         @id @default(cuid())
  propertyId        String         @map("property_id")
  tenantId          String         @map("tenant_id")
  startDate         DateTime       @map("start_date")
  endDate           DateTime       @map("end_date")
  rentAmount        Float          @map("rent_amount")
  depositAmount     Float          @map("deposit_amount")
  charges           Float          @default(0)
  paymentDay        Int            @default(1) @map("payment_day") // Jour du mois
  status            ContractStatus @default(DRAFT)
  terms             String?
  clauses           Json?          @db.JsonB
  signatureDate     DateTime?      @map("signature_date")
  signedDocument    String?        @map("signed_document") // URL S3
  autoRenewal       Boolean        @default(false) @map("auto_renewal")
  lastPaymentDate   DateTime?      @map("last_payment_date")
  balance           Float          @default(0) // Solde cumulé
  metadata          Json?          @db.JsonB
  createdById       String         @map("created_by_id")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  deletedAt         DateTime?      @map("deleted_at")

  property          Property       @relation(fields: [propertyId], references: [id])
  tenant            Tenant         @relation(fields: [tenantId], references: [id])
  createdBy         User           @relation("ContractCreatedBy", fields: [createdById], references: [id])
  payments          Payment[]
  amendments        ContractAmendment[]

  @@index([propertyId])
  @@index([tenantId])
  @@index([status, endDate])
  @@index([startDate, endDate])
  @@map("contracts")
}

model ContractAmendment {
  id         String   @id @default(cuid())
  contractId String   @map("contract_id")
  title      String
  content    String
  effectiveDate DateTime @map("effective_date")
  createdAt  DateTime @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_amendments")
}

model Payment {
  id              String        @id @default(cuid())
  contractId      String        @map("contract_id")
  tenantId        String        @map("tenant_id")
  amount          Float
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  reference       String?       @unique
  externalId      String?       @map("external_id") // Stripe ID, Orange Money ID
  dueDate         DateTime      @map("due_date")
  paidDate        DateTime?     @map("paid_date")
  receiptUrl      String?       @map("receipt_url")
  notes           String?
  metadata        Json?         @db.JsonB
  createdById     String        @map("created_by_id")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  contract        Contract      @relation(fields: [contractId], references: [id])
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  createdBy       User          @relation("PaymentCreatedBy", fields: [createdById], references: [id])

  @@index([contractId])
  @@index([tenantId])
  @@index([status, dueDate])
  @@index([paidDate])
  @@index([createdAt])
  @@map("payments")
}

model MaintenanceTicket {
  id          String              @id @default(cuid())
  propertyId  String              @map("property_id")
  tenantId    String?             @map("tenant_id")
  assignedTo  String?             @map("assigned_to")
  title       String
  description String
  priority    MaintenancePriority @default(MEDIUM)
  status      MaintenanceStatus   @default(OPEN)
  images      Json?               @db.JsonB
  cost        Float?
  resolvedAt  DateTime?           @map("resolved_at")
  metadata    Json?               @db.JsonB
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  property Property @relation(fields: [propertyId], references: [id])
  tenant   Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([propertyId])
  @@index([status, priority])
  @@index([createdAt])
  @@map("maintenance_tickets")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType @default(INFO)
  title     String
  message   String
  data      Json?            @db.JsonB
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id           String      @id @default(cuid())
  userId       String?     @map("user_id")
  action       AuditAction
  resourceType String      @map("resource_type")
  resourceId   String?     @map("resource_id")
  oldValues    Json?       @db.JsonB @map("old_values")
  newValues    Json?       @db.JsonB @map("new_values")
  ipAddress    String?     @map("ip_address")
  userAgent    String?     @map("user_agent")
  metadata     Json?       @db.JsonB
  createdAt    DateTime    @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action, createdAt])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// TimescaleDB Hypertable pour metrics temps réel
model Metric {
  time      DateTime @default(now())
  name      String
  value     Float
  labels    Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")

  @@index([time(sort: Desc)])
  @@index([name, time])
  @@map("metrics")
}
